<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard — FlowTier Leads</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="app-shell">

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-logo">
        <img src="/static/images/logo.webp" alt="FlowTier">
        <div class="app-label">Lead Management</div>
      </div>
      <nav class="sidebar-nav">
        <div class="nav-section-label">Pipeline</div>
        <a href="/" class="nav-item active" data-view="all">
          <span class="icon">&#9776;</span> All Leads <span class="count" id="countAll">0</span>
        </a>
        <div id="stageNav"></div>

        <div class="nav-section-label">Industries</div>
        <div id="industryNav"></div>
      </nav>
      <div class="sidebar-footer">
        <a href="/import" style="margin-bottom:8px;"><span class="icon">&#8679;</span> CSV Import</a>
        <a href="/dev"><span class="icon">&#9881;</span> Dev Console</a>
        <a href="/logout" style="margin-top:8px;"><span class="icon">&#10140;</span> Logout</a>
      </div>
    </aside>

    <!-- Main -->
    <main class="main-content">

      <!-- Header -->
      <div class="page-header">
        <div style="display:flex;align-items:center;gap:12px;">
          <button class="mobile-menu-btn" onclick="document.getElementById('sidebar').classList.toggle('mobile-open')">&#9776;</button>
          <h1 id="pageTitle">All <span>Leads</span></h1>
        </div>
        <div class="header-actions">
          <div class="view-toggle">
            <button id="viewTable" class="active" onclick="setView('table')">&#9776; Table</button>
            <button id="viewKanban" onclick="setView('kanban')">&#9638; Kanban</button>
          </div>
          <a href="/api/export/csv" class="btn btn-secondary btn-sm" id="exportBtn">&#8681; Export CSV</a>
          <a href="/import" class="btn btn-secondary btn-sm">&#8679; Import CSV</a>
          <a href="/new" class="btn btn-primary">&#43; New Lead</a>
        </div>
      </div>

      <!-- Overdue Alert -->
      <div class="overdue-alert" id="overdueAlert" style="display:none;">
        <span class="icon">&#9888;</span>
        <div><strong id="overdueCount">0</strong> leads have overdue follow-ups. <a href="#" onclick="filterOverdue(event)">View them</a></div>
      </div>

      <!-- Quick Stats -->
      <div class="stats-row" id="statsRow">
        <div class="stat-card">
          <div class="stat-value" id="statTotal" style="color:var(--color-text);">0</div>
          <div class="stat-label">Total Leads</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statPipeline" style="color:var(--color-primary);">$0</div>
          <div class="stat-label">Pipeline Value</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statConversion" style="color:var(--color-info);">0%</div>
          <div class="stat-label">Conversion Rate</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statWeek" style="color:var(--color-warning);">0</div>
          <div class="stat-label">This Week</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statAvgDeal" style="color:#CE93D8;">$0</div>
          <div class="stat-label">Avg Deal Value</div>
        </div>
      </div>

      <!-- Pipeline Bar -->
      <div class="pipeline-bar" id="pipelineBar"></div>

      <!-- Charts -->
      <div class="charts-row" id="chartsRow">
        <div class="chart-card">
          <h3>Pipeline Value by Stage</h3>
          <canvas id="pipelineChart"></canvas>
        </div>
        <div class="chart-card">
          <h3>Lead Source Performance</h3>
          <canvas id="sourceChart"></canvas>
        </div>
      </div>

      <!-- Activity Feed -->
      <div class="activity-feed" id="activityFeed">
        <h3>Recent Activity</h3>
        <div id="feedList"></div>
      </div>

      <!-- Toolbar -->
      <div class="toolbar">
        <div class="search-box">
          <span class="search-icon">&#128269;</span>
          <input type="text" id="searchInput" placeholder="Search leads... (press / to focus)">
        </div>
        <select class="filter-select" id="industryFilter">
          <option value="">All Industries</option>
        </select>
        <select class="filter-select" id="sourceFilter">
          <option value="">All Sources</option>
        </select>
      </div>

      <!-- Bulk Actions -->
      <div class="bulk-bar" id="bulkBar">
        <span class="bulk-count" id="bulkCount">0</span> selected
        <select class="filter-select" id="bulkStageSelect" style="margin-left:auto;">
          <option value="">Change Stage...</option>
        </select>
        <button class="btn btn-sm btn-secondary" id="bulkApplyStage">Apply</button>
        <button class="btn btn-sm btn-danger" id="bulkDeleteBtn">Delete</button>
        <button class="btn btn-sm btn-secondary" id="bulkClearBtn">Clear</button>
      </div>

      <!-- Table View -->
      <div id="tableView">
        <div style="overflow-x:auto;">
          <table class="lead-table" id="leadTable">
            <thead>
              <tr>
                <th class="checkbox-cell"><input type="checkbox" id="selectAll"></th>
                <th>Company</th>
                <th>Contact</th>
                <th>Email</th>
                <th>Industry</th>
                <th>Stage</th>
                <th>Score</th>
                <th>Deal Value</th>
                <th>Updated</th>
                <th class="actions-cell"></th>
              </tr>
            </thead>
            <tbody id="leadTableBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Kanban View -->
      <div id="kanbanView" style="display:none;">
        <div class="kanban-board" id="kanbanBoard"></div>
      </div>

      <div class="empty-state" id="emptyState" style="display:none;">
        <div class="icon">&#128203;</div>
        <h3>No leads found</h3>
        <p>Create your first lead or import from CSV.</p>
        <a href="/new" class="btn btn-primary">&#43; New Lead</a>
      </div>

    </main>
  </div>

  <!-- Keyboard shortcuts -->
  <div class="shortcuts-help">
    <span><span class="shortcut-key">N</span> New Lead</span>
    <span><span class="shortcut-key">/</span> Search</span>
    <span><span class="shortcut-key">K</span> Kanban</span>
    <span><span class="shortcut-key">Esc</span> Clear</span>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ════════════════════════════════════════
    // STATE
    // ════════════════════════════════════════
    let allLeads = [];
    let stages = [];
    let industries = [];
    let sources = [];
    let selectedIds = new Set();
    let currentStageFilter = '';
    let currentIndustryFilter = '';
    let currentView = 'table';
    let pipelineChart = null;
    let sourceChart = null;
    let showOverdueOnly = false;

    const pathParts = window.location.pathname.split('/');
    if (pathParts[1] === 'industry' && pathParts[2]) {
      currentIndustryFilter = decodeURIComponent(pathParts[2]);
    }

    // ════════════════════════════════════════
    // INIT
    // ════════════════════════════════════════
    document.addEventListener('DOMContentLoaded', async () => {
      await loadConfig();
      await loadLeads();
      await loadStats();
      setupEvents();
      setupKeyboardShortcuts();
    });

    async function loadConfig() {
      const [stagesRes, industriesRes, sourcesRes] = await Promise.all([
        fetch('/api/stages').then(r => r.json()),
        fetch('/api/industries').then(r => r.json()),
        fetch('/api/sources').then(r => r.json())
      ]);
      stages = stagesRes.stages;
      industries = industriesRes.industries;
      sources = sourcesRes.sources;
      renderSidebar();
      renderPipeline();
      renderFilters();
    }

    async function loadLeads() {
      const params = new URLSearchParams();
      if (currentIndustryFilter) params.set('industry', currentIndustryFilter);
      if (currentStageFilter) params.set('stage', currentStageFilter);

      const searchVal = document.getElementById('searchInput').value.trim();
      if (searchVal) params.set('search', searchVal);

      const industryVal = document.getElementById('industryFilter').value;
      if (industryVal && !currentIndustryFilter) params.set('industry', industryVal);

      const sourceVal = document.getElementById('sourceFilter').value;
      if (sourceVal) params.set('source', sourceVal);

      const res = await fetch('/api/leads?' + params.toString());
      const data = await res.json();
      allLeads = data.leads || [];

      if (showOverdueOnly) {
        const now = new Date();
        allLeads = allLeads.filter(l => l.next_followup && new Date(l.next_followup) < now && l.stage !== 'won' && l.stage !== 'lost');
      }

      renderCurrentView();
    }

    async function loadStats() {
      const data = await fetch('/api/stats').then(r => r.json());

      document.getElementById('statTotal').textContent = data.total_leads;
      document.getElementById('statPipeline').textContent = '$' + Number(data.total_deal_value).toLocaleString();
      document.getElementById('statConversion').textContent = data.conversion_rate + '%';
      document.getElementById('statWeek').textContent = data.leads_this_week;
      document.getElementById('statAvgDeal').textContent = '$' + Number(data.avg_deal_value).toLocaleString();

      document.getElementById('countAll').textContent = data.total_leads;

      // Overdue alert
      if (data.overdue_followups > 0) {
        document.getElementById('overdueAlert').style.display = 'flex';
        document.getElementById('overdueCount').textContent = data.overdue_followups;
      }

      // Update pipeline counts
      stages.forEach(s => {
        const stageData = data.by_stage[s.id] || { count: 0, deal_value: 0 };
        const el = document.getElementById('countStage_' + s.id);
        const pel = document.getElementById('pipeCount_' + s.id);
        const pval = document.getElementById('pipeVal_' + s.id);
        if (el) el.textContent = stageData.count;
        if (pel) pel.textContent = stageData.count;
        if (pval) pval.textContent = '$' + Number(stageData.deal_value).toLocaleString();
      });

      // Industry counts
      Object.keys(data.by_industry || {}).forEach(ind => {
        const el = document.getElementById('countInd_' + ind.replace(/\s/g, '_'));
        if (el) el.textContent = data.by_industry[ind];
      });

      // Charts
      renderCharts(data);

      // Activity feed
      renderActivityFeed(data.recent_activity || []);
    }

    // ════════════════════════════════════════
    // RENDER SIDEBAR
    // ════════════════════════════════════════
    function renderSidebar() {
      const stageNav = document.getElementById('stageNav');
      stageNav.innerHTML = stages.map(s => `
        <a href="#" class="nav-item ${currentStageFilter === s.id ? 'active' : ''}" data-stage="${s.id}" onclick="filterByStage('${s.id}', event)">
          <span class="icon" style="color:${s.color};">&#9679;</span> ${s.label}
          <span class="count" id="countStage_${s.id}">0</span>
        </a>
      `).join('');

      // Separate default industries from custom ones
      const defaultIndustries = industries.filter(ind => ind !== 'Other');
      
      // Find custom industries: industries used by leads that aren't in the default list
      const customIndustries = [];
      const defaultSet = new Set(industries.map(i => i.toLowerCase()));
      allLeads.forEach(l => {
        if (l.industry && !defaultSet.has(l.industry.toLowerCase())) {
          if (!customIndustries.includes(l.industry)) customIndustries.push(l.industry);
        }
      });
      customIndustries.sort();

      const industryNav = document.getElementById('industryNav');
      let html = defaultIndustries.map(ind => `
        <a href="/industry/${encodeURIComponent(ind)}" class="nav-item ${currentIndustryFilter === ind ? 'active' : ''}">
          <span class="icon">&#128193;</span> ${ind}
          <span class="count" id="countInd_${ind.replace(/\s/g, '_')}">0</span>
        </a>
      `).join('');

      // "Other" with expandable custom industries
      const otherCount = allLeads.filter(l => {
        if (!l.industry) return true;
        return !defaultSet.has(l.industry.toLowerCase()) || l.industry.toLowerCase() === 'other';
      }).length;
      const otherActive = currentIndustryFilter === 'Other' || customIndustries.includes(currentIndustryFilter);
      const otherExpanded = otherActive || customIndustries.length > 0;

      html += `
        <div class="nav-item-group">
          <a href="/industry/Other" class="nav-item ${currentIndustryFilter === 'Other' ? 'active' : ''}" style="position:relative;">
            <span class="icon">&#128193;</span> Other
            <span class="count" id="countInd_Other">${otherCount}</span>
            ${customIndustries.length > 0 ? '<span class="expand-toggle" onclick="event.preventDefault();event.stopPropagation();this.closest(\'.nav-item-group\').classList.toggle(\'expanded\');" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);cursor:pointer;font-size:0.7rem;color:var(--color-text-muted);padding:4px;">&#9660;</span>' : ''}
          </a>
          ${customIndustries.length > 0 ? `
            <div class="custom-industries-sub ${otherExpanded ? 'expanded' : ''}">
              ${customIndustries.map(ci => `
                <a href="/industry/${encodeURIComponent(ci)}" class="nav-item sub-item ${currentIndustryFilter === ci ? 'active' : ''}" style="padding-left:36px;font-size:0.75rem;">
                  <span class="icon" style="font-size:0.65rem;">&#9702;</span> ${ci}
                  <span class="count" id="countInd_${ci.replace(/\s/g, '_')}">0</span>
                </a>
              `).join('')}
            </div>
          ` : ''}
        </div>
      `;

      industryNav.innerHTML = html;
    }

    // ════════════════════════════════════════
    // RENDER PIPELINE BAR
    // ════════════════════════════════════════
    function renderPipeline() {
      const bar = document.getElementById('pipelineBar');
      bar.innerHTML = stages.map(s => `
        <div class="pipeline-card ${currentStageFilter === s.id ? 'active' : ''}" onclick="filterByStage('${s.id}')" style="cursor:pointer;">
          <div style="position:absolute;top:0;left:0;right:0;height:3px;background:${s.color};"></div>
          <div class="pipeline-count" id="pipeCount_${s.id}" style="color:${s.color};">0</div>
          <div class="pipeline-label">${s.label}</div>
          <div class="pipeline-value" id="pipeVal_${s.id}">$0</div>
        </div>
      `).join('');
    }

    function renderFilters() {
      const indFilter = document.getElementById('industryFilter');
      indFilter.innerHTML = '<option value="">All Industries</option>' +
        industries.map(i => `<option value="${i}" ${currentIndustryFilter === i ? 'selected' : ''}>${i}</option>`).join('');

      const srcFilter = document.getElementById('sourceFilter');
      srcFilter.innerHTML = '<option value="">All Sources</option>' +
        sources.map(s => `<option value="${s}">${s}</option>`).join('');

      const bulkStage = document.getElementById('bulkStageSelect');
      bulkStage.innerHTML = '<option value="">Change Stage...</option>' +
        stages.map(s => `<option value="${s.id}">${s.label}</option>`).join('');
    }

    // ════════════════════════════════════════
    // CHARTS
    // ════════════════════════════════════════
    function renderCharts(data) {
      // Pipeline value chart
      const pipeCtx = document.getElementById('pipelineChart').getContext('2d');
      if (pipelineChart) pipelineChart.destroy();
      pipelineChart = new Chart(pipeCtx, {
        type: 'bar',
        data: {
          labels: stages.map(s => s.label),
          datasets: [{
            label: 'Deal Value ($)',
            data: stages.map(s => (data.by_stage[s.id] || {}).deal_value || 0),
            backgroundColor: stages.map(s => s.color + '40'),
            borderColor: stages.map(s => s.color),
            borderWidth: 1,
            borderRadius: 4
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            y: { ticks: { color: '#666', callback: v => '$' + v.toLocaleString() }, grid: { color: 'rgba(255,255,255,0.05)' } },
            x: { ticks: { color: '#666' }, grid: { display: false } }
          }
        }
      });

      // Source performance chart
      const srcCtx = document.getElementById('sourceChart').getContext('2d');
      if (sourceChart) sourceChart.destroy();
      const srcLabels = Object.keys(data.by_source || {});
      const srcData = srcLabels.map(s => data.by_source[s].count);
      const srcColors = ['#00E676', '#64B5F6', '#FFB74D', '#CE93D8', '#4DD0E1', '#FF5252', '#90A4AE'];
      sourceChart = new Chart(srcCtx, {
        type: 'doughnut',
        data: {
          labels: srcLabels,
          datasets: [{
            data: srcData,
            backgroundColor: srcLabels.map((_, i) => srcColors[i % srcColors.length] + '60'),
            borderColor: srcLabels.map((_, i) => srcColors[i % srcColors.length]),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom', labels: { color: '#999', font: { size: 11 } } }
          }
        }
      });
    }

    // ════════════════════════════════════════
    // ACTIVITY FEED
    // ════════════════════════════════════════
    function renderActivityFeed(activities) {
      const list = document.getElementById('feedList');
      if (!activities.length) {
        list.innerHTML = '<div style="color:var(--color-text-muted);font-size:0.8125rem;">No recent activity.</div>';
        return;
      }
      list.innerHTML = activities.map(a => `
        <div class="feed-item">
          <div class="feed-dot ${a.type || ''}"></div>
          <div class="feed-msg">
            <a href="/lead/${a.lead_id}">${esc(a.company_name || a.contact_name || 'Lead')}</a>
            — ${esc(a.message)}
          </div>
          <div class="feed-time">${timeAgo(a.timestamp)}</div>
        </div>
      `).join('');
    }

    // ════════════════════════════════════════
    // VIEW TOGGLE
    // ════════════════════════════════════════
    function setView(view) {
      currentView = view;
      document.getElementById('viewTable').classList.toggle('active', view === 'table');
      document.getElementById('viewKanban').classList.toggle('active', view === 'kanban');
      document.getElementById('tableView').style.display = view === 'table' ? 'block' : 'none';
      document.getElementById('kanbanView').style.display = view === 'kanban' ? 'block' : 'none';
      renderCurrentView();
    }

    function renderCurrentView() {
      if (currentView === 'table') renderTable();
      else renderKanban();

      const empty = document.getElementById('emptyState');
      empty.style.display = allLeads.length === 0 ? 'block' : 'none';
    }

    // ════════════════════════════════════════
    // RENDER TABLE
    // ════════════════════════════════════════
    function renderTable() {
      const tbody = document.getElementById('leadTableBody');
      if (allLeads.length === 0) { tbody.innerHTML = ''; return; }

      tbody.innerHTML = allLeads.map(l => {
        const stage = stages.find(s => s.id === l.stage) || { label: l.stage, color: '#78909C' };
        const emails = (l.emails || []).join(', ');
        const dealVal = l.deal_value ? '$' + Number(l.deal_value).toLocaleString() : '—';
        const updated = l.updated_at ? timeAgo(l.updated_at) : '—';
        const score = l.lead_score || 0;
        const scoreClass = score >= 60 ? 'high' : score >= 30 ? 'medium' : 'low';

        return `<tr class="${selectedIds.has(l.id) ? 'selected' : ''}" data-id="${l.id}">
          <td class="checkbox-cell"><input type="checkbox" ${selectedIds.has(l.id) ? 'checked' : ''} onchange="toggleSelect('${l.id}')"></td>
          <td class="company-cell"><a href="/lead/${l.id}" style="color:inherit;text-decoration:none;">${esc(l.company_name || '—')}</a></td>
          <td class="contact-cell">${esc(l.contact_name || '—')}</td>
          <td class="email-cell">${esc(emails || '—')}</td>
          <td>${esc(l.industry || '—')}</td>
          <td><span class="stage-badge" style="background:${stage.color}20;color:${stage.color};">${stage.label}</span></td>
          <td><span class="score-badge ${scoreClass}">${score}</span></td>
          <td>${dealVal}</td>
          <td style="font-size:0.75rem;color:var(--color-text-muted);">${updated}</td>
          <td class="actions-cell">
            <a href="/lead/${l.id}" class="btn-icon" title="View" style="display:inline-flex;">&#128065;</a>
            <a href="/edit/${l.id}" class="btn-icon" title="Edit" style="display:inline-flex;">&#9998;</a>
          </td>
        </tr>`;
      }).join('');
    }

    // ════════════════════════════════════════
    // RENDER KANBAN
    // ════════════════════════════════════════
    function renderKanban() {
      const board = document.getElementById('kanbanBoard');
      const now = new Date();

      board.innerHTML = stages.map(s => {
        const stageLeads = allLeads.filter(l => l.stage === s.id);
        return `
          <div class="kanban-column" data-stage="${s.id}">
            <div class="kanban-column-header">
              <span class="kanban-column-title" style="color:${s.color};">${s.label}</span>
              <span class="kanban-column-count">${stageLeads.length}</span>
            </div>
            <div class="kanban-column-body" data-stage="${s.id}">
              ${stageLeads.length === 0 ? '<div class="kanban-empty-placeholder" style="color:var(--color-text-muted);font-size:0.75rem;text-align:center;padding:20px;">Drop leads here</div>' :
                stageLeads.map(l => {
                  const score = l.lead_score || 0;
                  const scoreClass = score >= 60 ? 'high' : score >= 30 ? 'medium' : 'low';
                  const isOverdue = l.next_followup && new Date(l.next_followup) < now && l.stage !== 'won' && l.stage !== 'lost';
                  return `
                    <div class="kanban-card" draggable="true" data-lead-id="${l.id}" data-stage="${s.id}">
                      <div class="kanban-card-company">${esc(l.company_name || '\u2014')}</div>
                      <div class="kanban-card-contact">${esc(l.contact_name || '')}</div>
                      <div class="kanban-card-footer">
                        <span class="kanban-card-value">${l.deal_value ? '$' + Number(l.deal_value).toLocaleString() : ''}</span>
                        <span class="kanban-card-score score-badge ${scoreClass}">${score}</span>
                      </div>
                      ${isOverdue ? '<div class="overdue-badge">OVERDUE</div>' : ''}
                    </div>
                  `;
                }).join('')
              }
            </div>
          </div>
        `;
      }).join('');

      // Setup drag and drop
      setupKanbanDragDrop();
    }

    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550
    // KANBAN DRAG & DROP
    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550
    let draggedCard = null;
    let draggedLeadId = null;

    function setupKanbanDragDrop() {
      // Card drag events
      document.querySelectorAll('.kanban-card[draggable]').forEach(card => {
        card.addEventListener('dragstart', (e) => {
          draggedCard = card;
          draggedLeadId = card.dataset.leadId;
          card.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/plain', card.dataset.leadId);
          // Delay to allow the drag image to be captured
          setTimeout(() => card.style.opacity = '0.4', 0);
        });

        card.addEventListener('dragend', () => {
          card.classList.remove('dragging');
          card.style.opacity = '';
          draggedCard = null;
          draggedLeadId = null;
          // Clean up all drag-over states
          document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
        });

        // Click to navigate (only if not dragging)
        card.addEventListener('click', (e) => {
          if (!card.classList.contains('dragging')) {
            window.location = '/lead/' + card.dataset.leadId;
          }
        });
      });

      // Column body drop zones
      document.querySelectorAll('.kanban-column-body').forEach(body => {
        body.addEventListener('dragover', (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'move';
          body.classList.add('drag-over');
          body.closest('.kanban-column').classList.add('drag-over');
        });

        body.addEventListener('dragleave', (e) => {
          // Only remove if leaving the body element itself
          if (!body.contains(e.relatedTarget)) {
            body.classList.remove('drag-over');
            body.closest('.kanban-column').classList.remove('drag-over');
          }
        });

        body.addEventListener('drop', async (e) => {
          e.preventDefault();
          body.classList.remove('drag-over');
          body.closest('.kanban-column').classList.remove('drag-over');

          const leadId = e.dataTransfer.getData('text/plain');
          const newStage = body.dataset.stage;

          if (!leadId || !newStage) return;

          // Find the lead and check if stage actually changed
          const lead = allLeads.find(l => l.id === leadId);
          if (!lead || lead.stage === newStage) return;

          // Optimistic UI update
          const oldStage = lead.stage;
          lead.stage = newStage;
          renderKanban();
          showToast(`Moved to ${stages.find(s => s.id === newStage)?.label || newStage}`, 'success');

          // API call to update stage
          try {
            const res = await fetch(`/api/leads/${leadId}`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ stage: newStage })
            });
            if (!res.ok) throw new Error('Failed to update');
            // Refresh stats
            loadStats();
          } catch (err) {
            // Revert on failure
            lead.stage = oldStage;
            renderKanban();
            showToast('Failed to move lead', 'error');
          }
        });
      });
    }

    // ════════════════════════════════════════
    // FILTERS
    // ════════════════════════════════════════
    function filterByStage(stageId, e) {
      if (e) e.preventDefault();
      showOverdueOnly = false;
      currentStageFilter = currentStageFilter === stageId ? '' : stageId;

      document.querySelectorAll('[data-stage]').forEach(el => {
        el.classList.toggle('active', el.dataset.stage === currentStageFilter);
      });
      document.querySelectorAll('.pipeline-card').forEach(el => el.classList.remove('active'));
      if (currentStageFilter) {
        const idx = stages.findIndex(s => s.id === currentStageFilter);
        const cards = document.querySelectorAll('.pipeline-card');
        if (cards[idx]) cards[idx].classList.add('active');
      }

      updateTitle();
      loadLeads();
    }

    function filterOverdue(e) {
      if (e) e.preventDefault();
      showOverdueOnly = true;
      currentStageFilter = '';
      updateTitle();
      loadLeads();
    }

    function updateTitle() {
      const title = document.getElementById('pageTitle');
      if (showOverdueOnly) {
        title.innerHTML = 'Overdue <span>Follow-ups</span>';
      } else if (currentStageFilter) {
        const s = stages.find(s => s.id === currentStageFilter);
        title.innerHTML = `${s ? s.label : ''} <span>Leads</span>`;
      } else if (currentIndustryFilter) {
        title.innerHTML = `${currentIndustryFilter} <span>Leads</span>`;
      } else {
        title.innerHTML = 'All <span>Leads</span>';
      }
    }

    // ════════════════════════════════════════
    // EVENTS
    // ════════════════════════════════════════
    function setupEvents() {
      let searchTimeout;
      document.getElementById('searchInput').addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(loadLeads, 300);
      });

      document.getElementById('industryFilter').addEventListener('change', () => {
        currentIndustryFilter = document.getElementById('industryFilter').value;
        loadLeads();
      });

      document.getElementById('sourceFilter').addEventListener('change', loadLeads);

      document.getElementById('selectAll').addEventListener('change', (e) => {
        if (e.target.checked) allLeads.forEach(l => selectedIds.add(l.id));
        else selectedIds.clear();
        renderTable();
        updateBulkBar();
      });

      document.getElementById('bulkApplyStage').addEventListener('click', bulkChangeStage);
      document.getElementById('bulkDeleteBtn').addEventListener('click', bulkDelete);
      document.getElementById('bulkClearBtn').addEventListener('click', () => {
        selectedIds.clear();
        document.getElementById('selectAll').checked = false;
        renderTable();
        updateBulkBar();
      });

      // Update export link with filters
      setInterval(() => {
        const params = new URLSearchParams();
        if (currentIndustryFilter) params.set('industry', currentIndustryFilter);
        if (currentStageFilter) params.set('stage', currentStageFilter);
        document.getElementById('exportBtn').href = '/api/export/csv' + (params.toString() ? '?' + params.toString() : '');
      }, 500);

      if (currentIndustryFilter) {
        document.getElementById('pageTitle').innerHTML = `${currentIndustryFilter} <span>Leads</span>`;
        document.title = `${currentIndustryFilter} — FlowTier Leads`;
      }
    }

    // ════════════════════════════════════════
    // KEYBOARD SHORTCUTS
    // ════════════════════════════════════════
    function setupKeyboardShortcuts() {
      document.addEventListener('keydown', (e) => {
        // Don't trigger when typing in inputs
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
          if (e.key === 'Escape') e.target.blur();
          return;
        }

        switch (e.key) {
          case 'n':
          case 'N':
            e.preventDefault();
            window.location.href = '/new';
            break;
          case '/':
            e.preventDefault();
            document.getElementById('searchInput').focus();
            break;
          case 'k':
          case 'K':
            e.preventDefault();
            setView(currentView === 'kanban' ? 'table' : 'kanban');
            break;
          case 'Escape':
            showOverdueOnly = false;
            currentStageFilter = '';
            document.getElementById('searchInput').value = '';
            updateTitle();
            loadLeads();
            break;
        }
      });
    }

    // ════════════════════════════════════════
    // SELECTION & BULK
    // ════════════════════════════════════════
    function toggleSelect(id) {
      if (selectedIds.has(id)) selectedIds.delete(id);
      else selectedIds.add(id);
      renderTable();
      updateBulkBar();
    }

    function updateBulkBar() {
      const bar = document.getElementById('bulkBar');
      const count = document.getElementById('bulkCount');
      if (selectedIds.size > 0) {
        bar.classList.add('visible');
        count.textContent = selectedIds.size;
      } else {
        bar.classList.remove('visible');
      }
    }

    async function bulkChangeStage() {
      const stage = document.getElementById('bulkStageSelect').value;
      if (!stage || selectedIds.size === 0) return;
      const res = await fetch('/api/leads/bulk/stage', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ids: [...selectedIds], stage })
      });
      const data = await res.json();
      if (data.success) {
        showToast(`Updated ${data.updated} leads`, 'success');
        selectedIds.clear();
        document.getElementById('selectAll').checked = false;
        updateBulkBar();
        loadLeads();
        loadStats();
      }
    }

    async function bulkDelete() {
      if (!confirm(`Delete ${selectedIds.size} leads? This cannot be undone.`)) return;
      const res = await fetch('/api/leads/bulk/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ids: [...selectedIds] })
      });
      const data = await res.json();
      if (data.success) {
        showToast(`Deleted ${data.deleted} leads`, 'success');
        selectedIds.clear();
        document.getElementById('selectAll').checked = false;
        updateBulkBar();
        loadLeads();
        loadStats();
      }
    }

    // ════════════════════════════════════════
    // HELPERS
    // ════════════════════════════════════════
    function esc(str) {
      if (!str) return '';
      const d = document.createElement('div');
      d.textContent = str;
      return d.innerHTML;
    }

    function timeAgo(dateStr) {
      const diff = Date.now() - new Date(dateStr).getTime();
      const mins = Math.floor(diff / 60000);
      if (mins < 1) return 'just now';
      if (mins < 60) return mins + 'm ago';
      const hrs = Math.floor(mins / 60);
      if (hrs < 24) return hrs + 'h ago';
      const days = Math.floor(hrs / 24);
      if (days < 30) return days + 'd ago';
      return new Date(dateStr).toLocaleDateString();
    }

    function showToast(msg, type) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.className = 'toast ' + type;
      setTimeout(() => t.classList.add('visible'), 10);
      setTimeout(() => t.classList.remove('visible'), 3000);
    }
  </script>
</body>
</html>
