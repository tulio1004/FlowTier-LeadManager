<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Campaign ‚Äî FlowTier Leads</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/style.css">
  <style>
    .campaign-page { max-width: 1200px; margin: 0 auto; padding: 2rem; padding-bottom: 4rem; }
    .back-link { display: inline-flex; align-items: center; gap: 0.5rem; color: var(--color-text-muted); font-size: 0.85rem; margin-bottom: 1.5rem; }
    .back-link:hover { color: var(--color-primary); text-decoration: none; }

    .page-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem; }
    .page-header h1 { font-size: 1.5rem; font-weight: 700; }
    .page-header h1 span { color: var(--color-primary); }
    .header-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; }

    .btn { display: inline-flex; align-items: center; gap: 0.4rem; padding: 0.5rem 1rem; border-radius: var(--radius-sm); font-size: 0.8rem; font-weight: 600; cursor: pointer; border: none; transition: var(--transition); text-decoration: none; }
    .btn-primary { background: var(--gradient-primary); color: var(--color-text-on-primary); }
    .btn-primary:hover { background: var(--gradient-primary-hover); text-decoration: none; }
    .btn-outline { background: transparent; border: 1px solid var(--color-border); color: var(--color-text-secondary); }
    .btn-outline:hover { border-color: var(--color-primary); color: var(--color-primary); text-decoration: none; }
    .btn-danger { background: rgba(255,82,82,0.15); color: #FF5252; border: 1px solid rgba(255,82,82,0.3); }
    .btn-danger:hover { background: rgba(255,82,82,0.25); text-decoration: none; }
    .btn-warning { background: rgba(255,183,77,0.15); color: #FFB74D; border: 1px solid rgba(255,183,77,0.3); }
    .btn-warning:hover { background: rgba(255,183,77,0.25); text-decoration: none; }
    .btn-success { background: rgba(0,230,118,0.15); color: #00E676; border: 1px solid rgba(0,230,118,0.3); }
    .btn-success:hover { background: rgba(0,230,118,0.25); text-decoration: none; }

    .campaign-status { display: inline-block; padding: 0.2rem 0.6rem; border-radius: 20px; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; }
    .campaign-status.draft { background: rgba(255,255,255,0.1); color: var(--color-text-muted); }
    .campaign-status.active { background: rgba(0,230,118,0.15); color: #00E676; }
    .campaign-status.paused { background: rgba(255,183,77,0.15); color: #FFB74D; }
    .campaign-status.completed { background: rgba(100,181,246,0.15); color: #64B5F6; }

    /* Tabs */
    .tabs { display: flex; gap: 0; border-bottom: 1px solid var(--color-border); margin-bottom: 1.5rem; overflow-x: auto; }
    .tab { padding: 0.75rem 1.25rem; font-size: 0.85rem; font-weight: 600; color: var(--color-text-muted); cursor: pointer; border-bottom: 2px solid transparent; transition: var(--transition); white-space: nowrap; }
    .tab:hover { color: var(--color-text-secondary); }
    .tab.active { color: var(--color-primary); border-bottom-color: var(--color-primary); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Stats Row */
    .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.75rem; margin-bottom: 1.5rem; }
    .stat-card { background: var(--color-bg-elevated); border: 1px solid var(--color-border); border-radius: var(--radius-md); padding: 1rem; text-align: center; }
    .stat-card .stat-value { font-size: 1.5rem; font-weight: 800; color: var(--color-primary); }
    .stat-card .stat-label { font-size: 0.65rem; color: var(--color-text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-top: 0.15rem; }

    /* Settings Panel */
    .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
    @media (max-width: 768px) { .settings-grid { grid-template-columns: 1fr; } }
    .settings-section { background: var(--color-bg-elevated); border: 1px solid var(--color-border); border-radius: var(--radius-md); padding: 1.5rem; }
    .settings-section h3 { font-size: 0.9rem; font-weight: 700; margin-bottom: 1rem; color: var(--color-text-secondary); }
    .form-group { margin-bottom: 1rem; }
    .form-group label { display: block; font-size: 0.7rem; color: var(--color-text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.3rem; }
    .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 0.5rem 0.7rem; background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-sm); color: var(--color-text); font-size: 0.85rem; font-family: var(--font-sans); }
    .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: var(--color-border-focus); }
    .form-group select option { background: var(--color-bg-elevated); color: var(--color-text); }

    .time-windows { margin-top: 0.5rem; }
    .time-window-row { display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem; }
    .time-window-row input { width: 120px; }
    .time-window-row span { color: var(--color-text-muted); font-size: 0.8rem; }
    .remove-window { background: none; border: none; color: var(--color-danger); cursor: pointer; font-size: 1rem; padding: 0 0.3rem; }

    .days-checkboxes { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.3rem; }
    .day-check { display: flex; align-items: center; gap: 0.3rem; }
    .day-check input[type="checkbox"] { width: auto; accent-color: var(--color-primary); }
    .day-check label { font-size: 0.8rem; color: var(--color-text-secondary); cursor: pointer; }

    /* Steps */
    .steps-list { display: flex; flex-direction: column; gap: 1rem; }
    .step-card { background: var(--color-bg-elevated); border: 1px solid var(--color-border); border-radius: var(--radius-md); padding: 1.25rem; position: relative; }
    .step-card.inactive { opacity: 0.5; }
    .step-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    .step-number { font-size: 0.75rem; font-weight: 700; color: var(--color-primary); text-transform: uppercase; }
    .step-actions { display: flex; gap: 0.5rem; }
    .step-actions button { background: none; border: none; cursor: pointer; font-size: 0.85rem; color: var(--color-text-muted); padding: 0.2rem 0.4rem; }
    .step-actions button:hover { color: var(--color-primary); }
    .step-delay { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem; }
    .step-delay input { width: 60px; text-align: center; }
    .step-delay span { font-size: 0.8rem; color: var(--color-text-muted); }

    .merge-fields { margin-top: 0.5rem; display: flex; flex-wrap: wrap; gap: 0.3rem; }
    .merge-field { font-size: 0.65rem; padding: 0.15rem 0.4rem; background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 4px; cursor: pointer; color: var(--color-text-muted); font-family: var(--font-mono); }
    .merge-field:hover { border-color: var(--color-primary); color: var(--color-primary); }

    /* Leads Tab */
    .leads-actions { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.75rem; }
    .leads-table { width: 100%; border-collapse: collapse; }
    .leads-table th { font-size: 0.7rem; color: var(--color-text-muted); text-transform: uppercase; letter-spacing: 0.05em; text-align: left; padding: 0.6rem 0.75rem; border-bottom: 1px solid var(--color-border); }
    .leads-table td { padding: 0.6rem 0.75rem; border-bottom: 1px solid var(--color-border-light); font-size: 0.85rem; }
    .leads-table tr:hover { background: var(--color-surface-hover); }

    .lead-status { display: inline-block; padding: 0.15rem 0.5rem; border-radius: 12px; font-size: 0.65rem; font-weight: 600; text-transform: uppercase; }
    .lead-status.pending { background: rgba(255,255,255,0.1); color: var(--color-text-muted); }
    .lead-status.sent { background: rgba(100,181,246,0.15); color: #64B5F6; }
    .lead-status.waiting { background: rgba(255,183,77,0.15); color: #FFB74D; }
    .lead-status.completed { background: rgba(0,230,118,0.15); color: #00E676; }
    .lead-status.replied { background: rgba(0,230,118,0.25); color: #00E676; }
    .lead-status.bounced { background: rgba(255,82,82,0.15); color: #FF5252; }
    .lead-status.opted_out { background: rgba(255,82,82,0.1); color: #FF5252; }
    .lead-status.error { background: rgba(255,82,82,0.15); color: #FF5252; }
    .lead-status.blacklisted { background: rgba(255,82,82,0.1); color: var(--color-text-muted); }

    /* Import Leads Modal */
    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center; }
    .modal-overlay.active { display: flex; }
    .modal { background: var(--color-bg-elevated); border: 1px solid var(--color-border); border-radius: var(--radius-lg); padding: 2rem; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; }
    .modal h2 { font-size: 1.1rem; margin-bottom: 1rem; }
    .modal h2 span { color: var(--color-primary); }
    .modal-actions { display: flex; justify-content: flex-end; gap: 0.75rem; margin-top: 1.5rem; }

    .lead-checkbox-list { max-height: 300px; overflow-y: auto; border: 1px solid var(--color-border); border-radius: var(--radius-sm); }
    .lead-checkbox-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.6rem 0.75rem; border-bottom: 1px solid var(--color-border-light); cursor: pointer; }
    .lead-checkbox-item:hover { background: var(--color-surface-hover); }
    .lead-checkbox-item input { width: auto; accent-color: var(--color-primary); }
    .lead-checkbox-item .lci-name { font-weight: 600; font-size: 0.85rem; }
    .lead-checkbox-item .lci-email { font-size: 0.75rem; color: var(--color-text-muted); }
    .lead-checkbox-item .lci-industry { font-size: 0.7rem; color: var(--color-text-muted); margin-left: auto; }

    .search-input { width: 100%; padding: 0.5rem 0.7rem; background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-sm); color: var(--color-text); font-size: 0.85rem; margin-bottom: 0.75rem; }
    .search-input:focus { outline: none; border-color: var(--color-border-focus); }

    .select-all-row { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; border-bottom: 1px solid var(--color-border); font-size: 0.8rem; color: var(--color-text-muted); }
    .select-all-row input { width: auto; accent-color: var(--color-primary); }

    /* Analytics */
    .analytics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
    @media (max-width: 768px) { .analytics-grid { grid-template-columns: 1fr; } }
    .analytics-card { background: var(--color-bg-elevated); border: 1px solid var(--color-border); border-radius: var(--radius-md); padding: 1.25rem; }
    .analytics-card h3 { font-size: 0.85rem; color: var(--color-text-secondary); margin-bottom: 1rem; }
    .progress-bar-container { margin-bottom: 0.75rem; }
    .progress-label { display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 0.3rem; }
    .progress-label span:first-child { color: var(--color-text-secondary); }
    .progress-label span:last-child { color: var(--color-text-muted); }
    .progress-bar { height: 6px; background: var(--color-surface); border-radius: 3px; overflow: hidden; }
    .progress-bar-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease; }

    .nav-bottom { position: fixed; bottom: 0; left: 0; right: 0; background: var(--color-bg-elevated); border-top: 1px solid var(--color-border); padding: 0.5rem 2rem; display: flex; gap: 1.5rem; align-items: center; font-size: 0.8rem; z-index: 100; }
    .nav-bottom a { color: var(--color-text-muted); text-decoration: none; }
    .nav-bottom a:hover { color: var(--color-primary); }
  </style>
</head>
<body>
  <div class="campaign-page">
    <a href="/campaigns" class="back-link">‚Üê Back to Campaigns</a>

    <div class="page-header">
      <div>
        <h1 id="campaignName">Loading...</h1>
        <span class="campaign-status draft" id="campaignStatus">draft</span>
        <span style="font-size:0.75rem;color:var(--color-text-muted);margin-left:0.5rem;" id="campaignMeta"></span>
      </div>
      <div class="header-actions" id="headerActions"></div>
    </div>

    <div class="stats-row" id="statsRow">
      <div class="stat-card"><div class="stat-value" id="statLeads">0</div><div class="stat-label">Leads</div></div>
      <div class="stat-card"><div class="stat-value" id="statSent">0</div><div class="stat-label">Sent</div></div>
      <div class="stat-card"><div class="stat-value" id="statReplies">0</div><div class="stat-label">Replies</div></div>
      <div class="stat-card"><div class="stat-value" id="statBounces">0</div><div class="stat-label">Bounces</div></div>
      <div class="stat-card"><div class="stat-value" id="statReplyRate">0%</div><div class="stat-label">Reply Rate</div></div>
      <div class="stat-card"><div class="stat-value" id="statToday">0</div><div class="stat-label">Sent Today</div></div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="settings">Settings</div>
      <div class="tab" data-tab="steps">Email Sequence</div>
      <div class="tab" data-tab="leads">Leads</div>
      <div class="tab" data-tab="analytics">Analytics</div>
    </div>

    <!-- SETTINGS TAB -->
    <div class="tab-content active" id="tab-settings">
      <div class="settings-grid">
        <div class="settings-section">
          <h3>Campaign Details</h3>
          <div class="form-group">
            <label>Campaign Name</label>
            <input type="text" id="settName">
          </div>
          <div class="form-group">
            <label>Description</label>
            <textarea id="settDesc" rows="3"></textarea>
          </div>
          <div class="form-group">
            <label>Webhook URL (Make.com)</label>
            <input type="url" id="settWebhook" placeholder="https://hook.us1.make.com/...">
          </div>
          <button class="btn btn-primary" onclick="saveSettings()" style="margin-top:0.5rem;">Save Settings</button>
        </div>

        <div class="settings-section">
          <h3>Schedule</h3>
          <div class="form-group">
            <label>Send 1 email every (minutes)</label>
            <input type="number" id="settFrequency" min="1" max="60" value="5">
          </div>
          <div class="form-group">
            <label>Daily Limit</label>
            <input type="number" id="settDailyLimit" min="1" max="500" value="50">
          </div>
          <div class="form-group">
            <label>Timezone</label>
            <select id="settTimezone">
              <option value="America/New_York">Eastern (ET)</option>
              <option value="America/Chicago">Central (CT)</option>
              <option value="America/Denver">Mountain (MT)</option>
              <option value="America/Los_Angeles">Pacific (PT)</option>
              <option value="America/Sao_Paulo">Brazil (BRT)</option>
              <option value="Europe/London">London (GMT)</option>
              <option value="Europe/Berlin">Berlin (CET)</option>
              <option value="UTC">UTC</option>
            </select>
          </div>
          <div class="form-group">
            <label>Active Days</label>
            <div class="days-checkboxes" id="daysCheckboxes"></div>
          </div>
          <div class="form-group">
            <label>Time Windows</label>
            <div id="timeWindows"></div>
            <button class="btn btn-outline" onclick="addTimeWindow()" style="margin-top:0.5rem;font-size:0.75rem;">+ Add Window</button>
          </div>
          <button class="btn btn-primary" onclick="saveSchedule()" style="margin-top:0.5rem;">Save Schedule</button>
        </div>
      </div>
    </div>

    <!-- STEPS TAB -->
    <div class="tab-content" id="tab-steps">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
        <p style="font-size:0.8rem;color:var(--color-text-muted);">Define your email sequence. Each step is sent after the specified delay. Use merge fields to personalize.</p>
        <button class="btn btn-primary" onclick="addStep()">+ Add Step</button>
      </div>
      <div class="merge-fields" style="margin-bottom:1rem;">
        <span style="font-size:0.7rem;color:var(--color-text-muted);margin-right:0.5rem;">Merge fields:</span>
        <span class="merge-field" onclick="copyMerge('{{contact_name}}')">{{contact_name}}</span>
        <span class="merge-field" onclick="copyMerge('{{first_name}}')">{{first_name}}</span>
        <span class="merge-field" onclick="copyMerge('{{company_name}}')">{{company_name}}</span>
        <span class="merge-field" onclick="copyMerge('{{industry}}')">{{industry}}</span>
        <span class="merge-field" onclick="copyMerge('{{website}}')">{{website}}</span>
        <span class="merge-field" onclick="copyMerge('{{email}}')">{{email}}</span>
        <span class="merge-field" onclick="copyMerge('{{phone}}')">{{phone}}</span>
        <span class="merge-field" onclick="copyMerge('{{deal_value}}')">{{deal_value}}</span>
        <span class="merge-field" onclick="copyMerge('{{address}}')">{{address}}</span>
      </div>
      <div class="steps-list" id="stepsList"></div>
      <button class="btn btn-primary" onclick="saveSteps()" style="margin-top:1rem;">Save Sequence</button>
    </div>

    <!-- LEADS TAB -->
    <div class="tab-content" id="tab-leads">
      <div class="leads-actions">
        <div style="display:flex;gap:0.5rem;">
          <button class="btn btn-primary" onclick="openImportLeads()">+ Import Leads</button>
          <button class="btn btn-outline" onclick="importByIndustry()">Import by Industry</button>
        </div>
        <span style="font-size:0.8rem;color:var(--color-text-muted);" id="leadsCount">0 leads</span>
      </div>
      <div style="overflow-x:auto;">
        <table class="leads-table" id="leadsTable">
          <thead>
            <tr>
              <th>Company</th>
              <th>Contact</th>
              <th>Email</th>
              <th>Step</th>
              <th>Status</th>
              <th>Last Sent</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="leadsBody"></tbody>
        </table>
      </div>
    </div>

    <!-- ANALYTICS TAB -->
    <div class="tab-content" id="tab-analytics">
      <div id="analyticsContent"></div>
    </div>
  </div>

  <!-- Import Leads Modal -->
  <div class="modal-overlay" id="importModal">
    <div class="modal">
      <h2>Import <span>Leads</span></h2>
      <input type="text" class="search-input" id="importSearch" placeholder="Search leads by name, company, or email..." oninput="filterImportLeads()">
      <div class="form-group">
        <label>Filter by Industry</label>
        <select id="importIndustryFilter" onchange="filterImportLeads()" style="width:100%;padding:0.5rem;background:var(--color-surface);border:1px solid var(--color-border);border-radius:var(--radius-sm);color:var(--color-text);font-size:0.85rem;">
          <option value="">All Industries</option>
        </select>
      </div>
      <div class="select-all-row">
        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
        <label for="selectAll">Select all visible</label>
        <span style="margin-left:auto;" id="selectedCount">0 selected</span>
      </div>
      <div class="lead-checkbox-list" id="importLeadsList"></div>
      <div class="modal-actions">
        <button class="btn btn-outline" onclick="closeImportLeads()">Cancel</button>
        <button class="btn btn-primary" onclick="importSelectedLeads()">Import Selected</button>
      </div>
    </div>
  </div>

  <!-- Industry Import Modal -->
  <div class="modal-overlay" id="industryModal">
    <div class="modal">
      <h2>Import by <span>Industry</span></h2>
      <p style="font-size:0.8rem;color:var(--color-text-muted);margin-bottom:1rem;">Select an industry to import all leads from that industry into this campaign.</p>
      <div id="industryList"></div>
      <div class="modal-actions">
        <button class="btn btn-outline" onclick="closeIndustryModal()">Cancel</button>
      </div>
    </div>
  </div>

  <div class="nav-bottom">
    <a href="/">Dashboard</a>
    <a href="/campaigns">Campaigns</a>
    <a href="/import">CSV Import</a>
    <a href="/dev">Dev Console</a>
    <a href="/logout">Logout</a>
  </div>

<script>
const campaignId = window.location.pathname.split('/').pop();
let campaign = null;
let allCrmLeads = [];

// ============================================
// LOAD CAMPAIGN
// ============================================
async function loadCampaign() {
  try {
    const res = await fetch(`/api/campaigns/${campaignId}`);
    if (!res.ok) { window.location = '/campaigns'; return; }
    campaign = await res.json();
    renderAll();
  } catch (err) {
    console.error('Failed to load campaign:', err);
  }
}

function renderAll() {
  // Header
  document.getElementById('campaignName').innerHTML = esc(campaign.name);
  const statusEl = document.getElementById('campaignStatus');
  statusEl.textContent = campaign.status;
  statusEl.className = `campaign-status ${campaign.status}`;
  document.getElementById('campaignMeta').textContent =
    campaign.started_at ? `Started ${new Date(campaign.started_at).toLocaleDateString()}` : `Created ${new Date(campaign.created_at).toLocaleDateString()}`;

  // Header Actions
  const actions = document.getElementById('headerActions');
  let btns = '';
  if (campaign.status === 'draft' || campaign.status === 'paused') {
    btns += `<button class="btn btn-success" onclick="startCampaign()">‚ñ∂ Start</button>`;
  }
  if (campaign.status === 'active') {
    btns += `<button class="btn btn-warning" onclick="pauseCampaign()">‚è∏ Pause</button>`;
  }
  btns += `<button class="btn btn-outline" onclick="cloneCampaign()">‚éò Clone</button>`;
  btns += `<button class="btn btn-danger" onclick="deleteCampaign()">üóë Delete</button>`;
  actions.innerHTML = btns;

  // Stats
  const replyRate = campaign.stats.emails_sent > 0
    ? Math.round((campaign.stats.replies_received / campaign.stats.emails_sent) * 100) : 0;
  document.getElementById('statLeads').textContent = campaign.leads.length;
  document.getElementById('statSent').textContent = campaign.stats.emails_sent;
  document.getElementById('statReplies').textContent = campaign.stats.replies_received;
  document.getElementById('statBounces').textContent = campaign.stats.bounces;
  document.getElementById('statReplyRate').textContent = replyRate + '%';
  document.getElementById('statToday').textContent = campaign.stats.sends_today;

  renderSettings();
  renderSteps();
  renderLeads();
  renderAnalytics();
}

// ============================================
// TABS
// ============================================
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');
  });
});

// ============================================
// SETTINGS TAB
// ============================================
function renderSettings() {
  document.getElementById('settName').value = campaign.name;
  document.getElementById('settDesc').value = campaign.description || '';
  document.getElementById('settWebhook').value = campaign.webhook_url || '';
  document.getElementById('settFrequency').value = campaign.schedule.frequency_minutes;
  document.getElementById('settDailyLimit').value = campaign.schedule.daily_limit;
  document.getElementById('settTimezone').value = campaign.schedule.timezone;

  // Days
  const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
  const daysContainer = document.getElementById('daysCheckboxes');
  daysContainer.innerHTML = dayNames.map((d, i) => `
    <div class="day-check">
      <input type="checkbox" id="day${i}" value="${i}" ${campaign.schedule.days_of_week.includes(i) ? 'checked' : ''}>
      <label for="day${i}">${d}</label>
    </div>
  `).join('');

  // Time windows
  renderTimeWindows();
}

function renderTimeWindows() {
  const container = document.getElementById('timeWindows');
  container.innerHTML = campaign.schedule.time_windows.map((w, i) => `
    <div class="time-window-row">
      <input type="time" value="${w.start}" onchange="updateWindow(${i}, 'start', this.value)">
      <span>to</span>
      <input type="time" value="${w.end}" onchange="updateWindow(${i}, 'end', this.value)">
      ${campaign.schedule.time_windows.length > 1 ? `<button class="remove-window" onclick="removeWindow(${i})">‚úï</button>` : ''}
    </div>
  `).join('');
}

function updateWindow(idx, field, value) {
  campaign.schedule.time_windows[idx][field] = value;
}

function removeWindow(idx) {
  campaign.schedule.time_windows.splice(idx, 1);
  renderTimeWindows();
}

function addTimeWindow() {
  campaign.schedule.time_windows.push({ start: '09:00', end: '17:00' });
  renderTimeWindows();
}

async function saveSettings() {
  const body = {
    name: document.getElementById('settName').value.trim(),
    description: document.getElementById('settDesc').value.trim(),
    webhook_url: document.getElementById('settWebhook').value.trim()
  };
  await patchCampaign(body);
  showToast('Settings saved');
}

async function saveSchedule() {
  const days = [];
  document.querySelectorAll('#daysCheckboxes input:checked').forEach(cb => days.push(parseInt(cb.value)));

  const body = {
    schedule: {
      frequency_minutes: parseInt(document.getElementById('settFrequency').value) || 5,
      daily_limit: parseInt(document.getElementById('settDailyLimit').value) || 50,
      timezone: document.getElementById('settTimezone').value,
      days_of_week: days,
      time_windows: campaign.schedule.time_windows
    }
  };
  await patchCampaign(body);
  showToast('Schedule saved');
}

// ============================================
// STEPS TAB
// ============================================
function renderSteps() {
  const container = document.getElementById('stepsList');
  if (!campaign.steps || campaign.steps.length === 0) {
    container.innerHTML = '<p style="color:var(--color-text-muted);text-align:center;padding:2rem;">No steps yet. Add your first email step.</p>';
    return;
  }

  container.innerHTML = campaign.steps.map((step, i) => `
    <div class="step-card ${step.active ? '' : 'inactive'}">
      <div class="step-header">
        <span class="step-number">Step ${step.step_number} ${!step.active ? '(disabled)' : ''}</span>
        <div class="step-actions">
          <button onclick="toggleStep(${i})" title="${step.active ? 'Disable' : 'Enable'}">${step.active ? 'üëÅ' : 'üëÅ‚Äçüó®'}</button>
          ${campaign.steps.length > 1 ? `<button onclick="removeStep(${i})" title="Remove">üóë</button>` : ''}
        </div>
      </div>
      ${i > 0 ? `
        <div class="step-delay">
          <span>Wait</span>
          <input type="number" min="0" max="30" value="${step.delay_days}" onchange="updateStepDelay(${i}, this.value)">
          <span>days after previous step</span>
        </div>
      ` : ''}
      <div class="form-group">
        <label>Subject Template</label>
        <input type="text" value="${esc(step.subject_template)}" onchange="updateStepField(${i}, 'subject_template', this.value)" placeholder="e.g., {{company_name}} - AI Automation Opportunity">
      </div>
      <div class="form-group">
        <label>Body Template / Instructions for AI</label>
        <textarea rows="5" onchange="updateStepField(${i}, 'body_template', this.value)" placeholder="Write the email template or instructions for your AI agent...">${esc(step.body_template)}</textarea>
      </div>
    </div>
  `).join('');
}

function addStep() {
  const nextNum = campaign.steps.length + 1;
  campaign.steps.push({
    id: crypto.randomUUID ? crypto.randomUUID() : Date.now().toString(),
    step_number: nextNum,
    subject_template: '',
    body_template: '',
    delay_days: 3,
    active: true
  });
  renderSteps();
}

function removeStep(idx) {
  campaign.steps.splice(idx, 1);
  campaign.steps.forEach((s, i) => s.step_number = i + 1);
  renderSteps();
}

function toggleStep(idx) {
  campaign.steps[idx].active = !campaign.steps[idx].active;
  renderSteps();
}

function updateStepField(idx, field, value) {
  campaign.steps[idx][field] = value;
}

function updateStepDelay(idx, value) {
  campaign.steps[idx].delay_days = parseInt(value) || 0;
}

async function saveSteps() {
  const res = await fetch(`/api/campaigns/${campaignId}/steps`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ steps: campaign.steps })
  });
  const data = await res.json();
  if (data.success) {
    campaign.steps = data.steps;
    renderSteps();
    showToast('Sequence saved');
  } else {
    alert(data.error || 'Failed to save steps');
  }
}

function copyMerge(field) {
  navigator.clipboard.writeText(field);
  showToast(`Copied: ${field}`);
}

// ============================================
// LEADS TAB
// ============================================
function renderLeads() {
  const body = document.getElementById('leadsBody');
  document.getElementById('leadsCount').textContent = `${campaign.leads.length} leads`;

  if (campaign.leads.length === 0) {
    body.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:2rem;color:var(--color-text-muted);">No leads in this campaign yet. Import leads to get started.</td></tr>`;
    return;
  }

  body.innerHTML = campaign.leads.map(entry => {
    const lastSent = entry.last_sent_at ? getTimeAgo(entry.last_sent_at) : '‚Äî';
    return `
      <tr>
        <td><a href="/lead/${entry.lead_id}" target="_blank" style="font-weight:600;">${esc(entry.company_name || entry.lead_id.substring(0, 8))}</a></td>
        <td>${esc(entry.contact_name || '')}</td>
        <td style="font-size:0.8rem;color:var(--color-text-secondary);">${esc(entry.email)}</td>
        <td>${entry.current_step || 1}/${campaign.steps.length}</td>
        <td><span class="lead-status ${entry.status}">${entry.status}</span></td>
        <td style="font-size:0.8rem;color:var(--color-text-muted);">${lastSent}</td>
        <td>
          <button class="btn btn-outline" style="padding:0.2rem 0.5rem;font-size:0.7rem;" onclick="removeLead('${entry.lead_id}')">Remove</button>
        </td>
      </tr>`;
  }).join('');
}

async function removeLead(leadId) {
  if (!confirm('Remove this lead from the campaign?')) return;
  await fetch(`/api/campaigns/${campaignId}/leads/${leadId}`, { method: 'DELETE' });
  await loadCampaign();
}

// Import Leads Modal
async function openImportLeads() {
  // Load all CRM leads
  try {
    const res = await fetch('/api/leads?limit=9999');
    const data = await res.json();
    allCrmLeads = data.leads || [];
  } catch { allCrmLeads = []; }

  // Load industries for filter
  try {
    const res = await fetch('/api/industries');
    const data = await res.json();
    const select = document.getElementById('importIndustryFilter');
    select.innerHTML = '<option value="">All Industries</option>' +
      (data.industries || []).map(i => `<option value="${i}">${i}</option>`).join('');
  } catch {}

  renderImportLeads();
  document.getElementById('importModal').classList.add('active');
}

function filterImportLeads() {
  renderImportLeads();
}

function renderImportLeads() {
  const search = (document.getElementById('importSearch').value || '').toLowerCase();
  const industry = document.getElementById('importIndustryFilter').value;
  const existingIds = new Set(campaign.leads.map(l => l.lead_id));

  const filtered = allCrmLeads.filter(l => {
    if (existingIds.has(l.id)) return false; // already in campaign
    if (!(l.emails || []).length) return false; // no email
    if (search && !`${l.contact_name} ${l.company_name} ${(l.emails||[]).join(' ')}`.toLowerCase().includes(search)) return false;
    if (industry && l.industry !== industry) return false;
    return true;
  });

  const container = document.getElementById('importLeadsList');
  container.innerHTML = filtered.map(l => `
    <label class="lead-checkbox-item">
      <input type="checkbox" value="${l.id}" class="import-check" onchange="updateSelectedCount()">
      <div>
        <div class="lci-name">${esc(l.company_name || l.contact_name)}</div>
        <div class="lci-email">${esc((l.emails||[])[0] || '')}</div>
      </div>
      <div class="lci-industry">${esc(l.industry || '')}</div>
    </label>
  `).join('');

  document.getElementById('selectAll').checked = false;
  updateSelectedCount();
}

function toggleSelectAll() {
  const checked = document.getElementById('selectAll').checked;
  document.querySelectorAll('.import-check').forEach(cb => cb.checked = checked);
  updateSelectedCount();
}

function updateSelectedCount() {
  const count = document.querySelectorAll('.import-check:checked').length;
  document.getElementById('selectedCount').textContent = `${count} selected`;
}

function closeImportLeads() {
  document.getElementById('importModal').classList.remove('active');
}

async function importSelectedLeads() {
  const ids = Array.from(document.querySelectorAll('.import-check:checked')).map(cb => cb.value);
  if (ids.length === 0) { alert('Select at least one lead'); return; }

  // Enrich lead entries with name/company for display
  const res = await fetch(`/api/campaigns/${campaignId}/leads`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ lead_ids: ids })
  });
  const data = await res.json();
  if (data.success) {
    closeImportLeads();
    await loadCampaign();
    showToast(`${data.added} leads imported`);
  } else {
    alert(data.error || 'Failed to import');
  }
}

// Import by Industry
async function importByIndustry() {
  try {
    const res = await fetch('/api/industries');
    const data = await res.json();
    const container = document.getElementById('industryList');
    container.innerHTML = (data.industries || []).map(ind => `
      <button class="btn btn-outline" style="margin:0.25rem;" onclick="doIndustryImport('${esc(ind)}')">${esc(ind)}</button>
    `).join('');
    document.getElementById('industryModal').classList.add('active');
  } catch {}
}

async function doIndustryImport(industry) {
  try {
    const res = await fetch(`/api/leads?industry=${encodeURIComponent(industry)}&limit=9999`);
    const data = await res.json();
    const ids = (data.leads || []).filter(l => (l.emails||[]).length > 0).map(l => l.id);

    if (ids.length === 0) { alert(`No leads with email found in ${industry}`); return; }

    const importRes = await fetch(`/api/campaigns/${campaignId}/leads`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ lead_ids: ids })
    });
    const importData = await importRes.json();
    closeIndustryModal();
    await loadCampaign();
    showToast(`${importData.added} ${industry} leads imported`);
  } catch (err) {
    alert('Error: ' + err.message);
  }
}

function closeIndustryModal() {
  document.getElementById('industryModal').classList.remove('active');
}

// ============================================
// ANALYTICS TAB
// ============================================
function renderAnalytics() {
  const total = campaign.leads.length;
  const sent = campaign.stats.emails_sent;
  const replies = campaign.stats.replies_received;
  const bounces = campaign.stats.bounces;
  const optedOut = campaign.stats.opted_out || 0;

  const statusCounts = {};
  campaign.leads.forEach(l => { statusCounts[l.status] = (statusCounts[l.status] || 0) + 1; });

  const replyRate = sent > 0 ? Math.round((replies / sent) * 100) : 0;
  const bounceRate = sent > 0 ? Math.round((bounces / sent) * 100) : 0;

  const container = document.getElementById('analyticsContent');
  container.innerHTML = `
    <div class="analytics-grid">
      <div class="analytics-card">
        <h3>Lead Status Breakdown</h3>
        ${Object.entries(statusCounts).map(([status, count]) => {
          const pct = total > 0 ? Math.round((count / total) * 100) : 0;
          const color = statusColors[status] || '#fff';
          return `
            <div class="progress-bar-container">
              <div class="progress-label"><span>${status}</span><span>${count} (${pct}%)</span></div>
              <div class="progress-bar"><div class="progress-bar-fill" style="width:${pct}%;background:${color};"></div></div>
            </div>`;
        }).join('')}
      </div>

      <div class="analytics-card">
        <h3>Performance Metrics</h3>
        <div class="progress-bar-container">
          <div class="progress-label"><span>Reply Rate</span><span>${replyRate}%</span></div>
          <div class="progress-bar"><div class="progress-bar-fill" style="width:${replyRate}%;background:#00E676;"></div></div>
        </div>
        <div class="progress-bar-container">
          <div class="progress-label"><span>Bounce Rate</span><span>${bounceRate}%</span></div>
          <div class="progress-bar"><div class="progress-bar-fill" style="width:${bounceRate}%;background:#FF5252;"></div></div>
        </div>
        <div class="progress-bar-container">
          <div class="progress-label"><span>Completion</span><span>${total > 0 ? Math.round(((statusCounts.completed || 0) + (statusCounts.replied || 0)) / total * 100) : 0}%</span></div>
          <div class="progress-bar"><div class="progress-bar-fill" style="width:${total > 0 ? Math.round(((statusCounts.completed || 0) + (statusCounts.replied || 0)) / total * 100) : 0}%;background:#64B5F6;"></div></div>
        </div>
        <div style="margin-top:1rem;font-size:0.8rem;color:var(--color-text-muted);">
          <p>Total emails sent: <strong style="color:var(--color-text);">${sent}</strong></p>
          <p>Sends today: <strong style="color:var(--color-text);">${campaign.stats.sends_today}</strong> / ${campaign.schedule.daily_limit}</p>
          <p>Opted out: <strong style="color:var(--color-text);">${optedOut}</strong></p>
        </div>
      </div>

      <div class="analytics-card" style="grid-column:1/-1;">
        <h3>Step Performance</h3>
        ${campaign.steps.map(step => {
          const sentInStep = campaign.leads.filter(l => (l.last_step_sent || 0) >= step.step_number).length;
          const pct = total > 0 ? Math.round((sentInStep / total) * 100) : 0;
          return `
            <div class="progress-bar-container">
              <div class="progress-label"><span>Step ${step.step_number}: ${esc(step.subject_template || '(no subject)').substring(0, 50)}</span><span>${sentInStep} sent (${pct}%)</span></div>
              <div class="progress-bar"><div class="progress-bar-fill" style="width:${pct}%;background:var(--color-primary);"></div></div>
            </div>`;
        }).join('')}
      </div>
    </div>`;
}

const statusColors = {
  pending: 'rgba(255,255,255,0.3)',
  sent: '#64B5F6',
  waiting: '#FFB74D',
  completed: '#00E676',
  replied: '#4CAF50',
  bounced: '#FF5252',
  opted_out: '#FF8A80',
  blacklisted: '#757575',
  error: '#FF1744'
};

// ============================================
// CAMPAIGN ACTIONS
// ============================================
async function startCampaign() {
  const res = await fetch(`/api/campaigns/${campaignId}/start`, { method: 'POST' });
  const data = await res.json();
  if (data.success) {
    showToast('Campaign started!');
    await loadCampaign();
  } else {
    alert(data.error || 'Failed to start');
  }
}

async function pauseCampaign() {
  const res = await fetch(`/api/campaigns/${campaignId}/pause`, { method: 'POST' });
  const data = await res.json();
  if (data.success) {
    showToast('Campaign paused');
    await loadCampaign();
  } else {
    alert(data.error || 'Failed to pause');
  }
}

async function cloneCampaign() {
  const res = await fetch(`/api/campaigns/${campaignId}/clone`, { method: 'POST' });
  const data = await res.json();
  if (data.success) {
    window.location = `/campaigns/${data.campaign.id}`;
  }
}

async function deleteCampaign() {
  if (!confirm('Are you sure you want to delete this campaign? This cannot be undone.')) return;
  await fetch(`/api/campaigns/${campaignId}`, { method: 'DELETE' });
  window.location = '/campaigns';
}

async function patchCampaign(body) {
  const res = await fetch(`/api/campaigns/${campaignId}`, {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });
  const data = await res.json();
  if (data.success) {
    campaign = data.campaign;
    renderAll();
  }
  return data;
}

// ============================================
// HELPERS
// ============================================
function esc(str) {
  if (!str) return '';
  const d = document.createElement('div');
  d.textContent = str;
  return d.innerHTML;
}

function getTimeAgo(dateStr) {
  if (!dateStr) return '';
  const diff = Date.now() - new Date(dateStr).getTime();
  const mins = Math.floor(diff / 60000);
  if (mins < 1) return 'just now';
  if (mins < 60) return `${mins}m ago`;
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return `${hrs}h ago`;
  const days = Math.floor(hrs / 24);
  return `${days}d ago`;
}

function showToast(msg) {
  const toast = document.createElement('div');
  toast.textContent = msg;
  toast.style.cssText = 'position:fixed;bottom:60px;right:20px;background:var(--color-primary);color:#000;padding:0.6rem 1.2rem;border-radius:8px;font-size:0.85rem;font-weight:600;z-index:9999;animation:fadeIn 0.3s ease;';
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 2500);
}

// Close modals on Esc
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    closeImportLeads();
    closeIndustryModal();
  }
});

document.querySelectorAll('.modal-overlay').forEach(m => {
  m.addEventListener('click', e => { if (e.target === e.currentTarget) e.target.classList.remove('active'); });
});

// Enrich campaign leads with names for display
async function enrichLeadNames() {
  if (!campaign || !campaign.leads.length) return;
  for (const entry of campaign.leads) {
    if (entry.company_name) continue; // already enriched
    try {
      const res = await fetch(`/api/leads/${entry.lead_id}`);
      if (res.ok) {
        const data = await res.json();
        const lead = data.lead || data;
        entry.company_name = lead.company_name || '';
        entry.contact_name = lead.contact_name || '';
      }
    } catch {}
  }
  renderLeads();
}

// Init
loadCampaign().then(() => enrichLeadNames());
</script>
</body>
</html>
