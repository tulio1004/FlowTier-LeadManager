<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lead Detail — FlowTier Leads</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <div class="app-shell">

    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-logo">
        <img src="/static/images/logo.webp" alt="FlowTier">
        <div class="app-label">Lead Management</div>
      </div>
      <nav class="sidebar-nav">
        <a href="/" class="nav-item"><span class="icon">&#8592;</span> Back to Dashboard</a>
      </nav>
      <div class="sidebar-footer">
        <a href="/dev"><span class="icon">&#9881;</span> Dev Console</a>
        <a href="/logout" style="margin-top:8px;"><span class="icon">&#10140;</span> Logout</a>
      </div>
    </aside>

    <!-- Main -->
    <main class="main-content">

      <!-- Header -->
      <div class="detail-header">
        <div>
          <div class="detail-title" id="leadName">Loading...</div>
          <div class="detail-company" id="leadCompany"></div>
        </div>
        <div class="header-actions">
          <select class="filter-select" id="stageSelect" style="font-weight:600;"></select>
          <a href="#" class="btn btn-secondary btn-sm" id="editBtn">&#9998; Edit</a>
          <button class="btn btn-danger btn-sm" id="deleteBtn">&#128465; Delete</button>
        </div>
      </div>

      <div class="detail-grid">

        <!-- LEFT COLUMN -->
        <div class="detail-left">

          <!-- Contact Info -->
          <div class="detail-card">
            <h3>Contact Information</h3>
            <div id="contactInfo"></div>
          </div>

          <!-- Company Info -->
          <div class="detail-card">
            <h3>Company Details</h3>
            <div id="companyInfo"></div>
          </div>

          <!-- Enrichment / Details -->
          <div class="detail-card">
            <h3>Enrichment Data</h3>
            <div id="enrichmentData" style="font-size:0.8125rem;color:var(--color-text-secondary);line-height:1.7;white-space:pre-wrap;"></div>
          </div>

          <!-- Calendar Event -->
          <div class="detail-card" id="calendarSection" style="display:none;">
            <h3>Scheduled Call</h3>
            <div id="calendarContent"></div>
          </div>

          <!-- Proposal Link -->
          <div class="detail-card" id="proposalSection" style="display:none;">
            <h3>Proposal</h3>
            <div id="proposalContent"></div>
          </div>

        </div>

        <!-- RIGHT COLUMN -->
        <div class="detail-right">

          <!-- Quick Stats -->
          <div class="detail-card">
            <h3>Overview</h3>
            <div id="overviewInfo"></div>
          </div>

          <!-- Notes -->
          <div class="detail-card">
            <h3>Notes &amp; Snapshots</h3>
            <div class="note-input-area">
              <textarea id="noteInput" placeholder="Write a note, call snapshot, or observation..."></textarea>
            </div>
            <div style="display:flex;gap:8px;margin-bottom:16px;">
              <select class="filter-select" id="noteType" style="padding:6px 10px;font-size:0.75rem;">
                <option value="note">Note</option>
                <option value="call_snapshot">Call Snapshot</option>
                <option value="follow_up">Follow-up</option>
                <option value="research">Research</option>
              </select>
              <button class="btn btn-primary btn-sm" id="addNoteBtn">Add Note</button>
            </div>
            <div id="notesList"></div>
          </div>

          <!-- Activity Timeline -->
          <div class="detail-card">
            <h3>Activity Timeline</h3>
            <div id="activityTimeline"></div>
          </div>

        </div>
      </div>

    </main>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const leadId = window.location.pathname.split('/').pop();
    let lead = null;
    let stages = [];

    document.addEventListener('DOMContentLoaded', async () => {
      stages = (await fetch('/api/stages').then(r => r.json())).stages;
      await loadLead();
      setupEvents();
    });

    async function loadLead() {
      const res = await fetch('/api/leads/' + leadId);
      if (!res.ok) {
        document.querySelector('.detail-title').textContent = 'Lead not found';
        return;
      }
      lead = await res.json();
      render();
    }

    function render() {
      document.title = `${lead.contact_name || lead.company_name} — FlowTier Leads`;
      document.getElementById('leadName').textContent = lead.contact_name || 'Unknown Contact';
      document.getElementById('leadCompany').textContent = lead.company_name || '';
      document.getElementById('editBtn').href = '/edit/' + lead.id;

      // Stage select
      const stageSelect = document.getElementById('stageSelect');
      stageSelect.innerHTML = stages.map(s =>
        `<option value="${s.id}" ${lead.stage === s.id ? 'selected' : ''}>${s.label}</option>`
      ).join('');

      // Contact info
      document.getElementById('contactInfo').innerHTML = `
        ${infoRow('Name', lead.contact_name)}
        ${infoRow('Email(s)', (lead.emails || []).map(e => `<a href="mailto:${esc(e)}">${esc(e)}</a>`).join('<br>') || '—')}
        ${infoRow('Phone(s)', (lead.phones || []).map(p => `<a href="tel:${esc(p)}">${esc(p)}</a>`).join('<br>') || '—')}
        ${infoRow('LinkedIn', lead.linkedin ? `<a href="${esc(lead.linkedin)}" target="_blank">${esc(lead.linkedin)}</a>` : '—')}
        ${infoRow('Address', lead.address)}
      `;

      // Company info
      document.getElementById('companyInfo').innerHTML = `
        ${infoRow('Company', lead.company_name)}
        ${infoRow('Industry', lead.industry)}
        ${infoRow('Website', lead.website ? `<a href="${esc(lead.website)}" target="_blank">${esc(lead.website)}</a>` : '—')}
        ${infoRow('Size', lead.company_size)}
        ${infoRow('Revenue Est.', lead.revenue_estimate)}
        ${infoRow('Source', lead.lead_source)}
      `;

      // Enrichment
      const enrichEl = document.getElementById('enrichmentData');
      enrichEl.textContent = lead.details || 'No enrichment data yet.';

      // Overview
      const stage = stages.find(s => s.id === lead.stage) || { label: lead.stage, color: '#78909C' };
      document.getElementById('overviewInfo').innerHTML = `
        ${infoRow('Stage', `<span class="stage-badge" style="background:${stage.color}20;color:${stage.color};">${stage.label}</span>`)}
        ${infoRow('Deal Value', lead.deal_value ? '$' + Number(lead.deal_value).toLocaleString() : '—')}
        ${infoRow('Tags', (lead.tags || []).map(t => `<span class="tag-chip">${esc(t)}</span>`).join(' ') || '—')}
        ${infoRow('Assigned To', lead.assigned_to || '—')}
        ${infoRow('Last Contacted', lead.last_contacted ? formatDate(lead.last_contacted) : 'Never')}
        ${infoRow('Next Follow-up', lead.next_followup ? formatDate(lead.next_followup) : 'Not set')}
        ${infoRow('Created', formatDate(lead.created_at))}
      `;

      // Calendar
      if (lead.calendar_event && lead.calendar_event.title) {
        document.getElementById('calendarSection').style.display = 'block';
        const cal = lead.calendar_event;
        document.getElementById('calendarContent').innerHTML = `
          <div class="calendar-card">
            <div class="cal-title">${esc(cal.title)}</div>
            ${cal.start_time ? `<div class="cal-detail">&#128197; ${formatDate(cal.start_time)}${cal.end_time ? ' — ' + formatDate(cal.end_time) : ''}</div>` : ''}
            ${cal.description ? `<div class="cal-detail" style="margin-top:6px;">${esc(cal.description)}</div>` : ''}
            ${cal.attendees && cal.attendees.length ? `<div class="cal-detail">&#128101; ${cal.attendees.map(a => esc(a)).join(', ')}</div>` : ''}
            ${cal.meet_link ? `<a href="${esc(cal.meet_link)}" target="_blank" class="cal-link">&#127760; Join Meeting</a>` : ''}
            ${cal.event_id ? `<a href="https://calendar.google.com/calendar/event?eid=${esc(cal.event_id)}" target="_blank" class="cal-link" style="margin-left:12px;">&#128197; View in Google Calendar</a>` : ''}
          </div>
        `;
      }

      // Proposal
      if (lead.proposal_url) {
        document.getElementById('proposalSection').style.display = 'block';
        document.getElementById('proposalContent').innerHTML = `
          <a href="${esc(lead.proposal_url)}" target="_blank" class="btn btn-secondary btn-sm">&#128196; View Proposal</a>
        `;
      }

      // Notes
      renderNotes();

      // Activity
      renderActivity();
    }

    function renderNotes() {
      const list = document.getElementById('notesList');
      if (!lead.notes || lead.notes.length === 0) {
        list.innerHTML = '<div style="color:var(--color-text-muted);font-size:0.8125rem;padding:12px 0;">No notes yet. Add your first note above.</div>';
        return;
      }
      list.innerHTML = lead.notes.map(n => `
        <div class="note-item">
          <div class="note-meta">
            <span class="note-type">${esc(n.type || 'note')}</span>
            <div>
              <span class="note-time">${formatDate(n.created_at)}</span>
              <button class="note-delete" onclick="deleteNote('${n.id}')" title="Delete">&#10005;</button>
            </div>
          </div>
          <div class="note-content">${esc(n.content)}</div>
        </div>
      `).join('');
    }

    function renderActivity() {
      const timeline = document.getElementById('activityTimeline');
      const activities = (lead.activity || []).slice().reverse();
      if (activities.length === 0) {
        timeline.innerHTML = '<div style="color:var(--color-text-muted);font-size:0.8125rem;">No activity yet.</div>';
        return;
      }
      timeline.innerHTML = activities.map(a => `
        <div class="timeline-item">
          <div class="timeline-dot ${a.type || ''}"></div>
          <div class="timeline-msg">${esc(a.message)}</div>
          <div class="timeline-time">${timeAgo(a.timestamp)}</div>
        </div>
      `).join('');
    }

    // ════════════════════════════════════════
    // EVENTS
    // ════════════════════════════════════════
    function setupEvents() {
      // Stage change
      document.getElementById('stageSelect').addEventListener('change', async (e) => {
        const newStage = e.target.value;
        const res = await fetch('/api/leads/' + leadId, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ stage: newStage })
        });
        if (res.ok) {
          showToast('Stage updated', 'success');
          await loadLead();
        }
      });

      // Add note
      document.getElementById('addNoteBtn').addEventListener('click', async () => {
        const content = document.getElementById('noteInput').value.trim();
        if (!content) return;
        const type = document.getElementById('noteType').value;

        const res = await fetch('/api/leads/' + leadId + '/notes', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ content, type })
        });
        if (res.ok) {
          document.getElementById('noteInput').value = '';
          showToast('Note added', 'success');
          await loadLead();
        }
      });

      // Delete lead
      document.getElementById('deleteBtn').addEventListener('click', async () => {
        if (!confirm('Delete this lead permanently?')) return;
        await fetch('/api/leads/' + leadId, { method: 'DELETE' });
        window.location.href = '/';
      });

      // Ctrl+Enter to add note
      document.getElementById('noteInput').addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
          document.getElementById('addNoteBtn').click();
        }
      });
    }

    async function deleteNote(noteId) {
      if (!confirm('Delete this note?')) return;
      await fetch(`/api/leads/${leadId}/notes/${noteId}`, { method: 'DELETE' });
      showToast('Note deleted', 'success');
      await loadLead();
    }

    // ════════════════════════════════════════
    // HELPERS
    // ════════════════════════════════════════
    function infoRow(label, value) {
      return `<div class="info-row"><span class="info-label">${label}</span><span class="info-value">${value || '—'}</span></div>`;
    }

    function esc(str) {
      if (!str) return '';
      const d = document.createElement('div');
      d.textContent = str;
      return d.innerHTML;
    }

    function formatDate(dateStr) {
      if (!dateStr) return '—';
      const d = new Date(dateStr);
      return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit' });
    }

    function timeAgo(dateStr) {
      const diff = Date.now() - new Date(dateStr).getTime();
      const mins = Math.floor(diff / 60000);
      if (mins < 1) return 'just now';
      if (mins < 60) return mins + 'm ago';
      const hrs = Math.floor(mins / 60);
      if (hrs < 24) return hrs + 'h ago';
      const days = Math.floor(hrs / 24);
      if (days < 30) return days + 'd ago';
      return new Date(dateStr).toLocaleDateString();
    }

    function showToast(msg, type) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.className = 'toast ' + type;
      setTimeout(() => t.classList.add('visible'), 10);
      setTimeout(() => t.classList.remove('visible'), 3000);
    }
  </script>
</body>
</html>
