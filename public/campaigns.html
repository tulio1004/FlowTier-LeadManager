<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Campaigns — FlowTier Leads</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/style.css">
  <style>
    .campaigns-page { max-width: 1200px; margin: 0 auto; padding: 2rem; }
    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem; }
    .page-header h1 { font-size: 1.5rem; font-weight: 700; }
    .page-header h1 span { color: var(--color-primary); }

    .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
    .stat-card { background: var(--color-bg-elevated); border: 1px solid var(--color-border); border-radius: var(--radius-md); padding: 1.25rem; text-align: center; }
    .stat-card .stat-value { font-size: 1.75rem; font-weight: 800; color: var(--color-primary); }
    .stat-card .stat-label { font-size: 0.75rem; color: var(--color-text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-top: 0.25rem; }

    .campaigns-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 1.25rem; }
    .campaign-card { background: var(--color-bg-elevated); border: 1px solid var(--color-border); border-radius: var(--radius-md); padding: 1.5rem; cursor: pointer; transition: var(--transition); }
    .campaign-card:hover { border-color: var(--color-primary); box-shadow: var(--shadow-glow); transform: translateY(-2px); }
    .campaign-card .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem; }
    .campaign-card .card-name { font-size: 1.1rem; font-weight: 700; }
    .campaign-card .card-desc { color: var(--color-text-secondary); font-size: 0.8rem; margin-bottom: 1rem; line-height: 1.4; }

    .campaign-status { display: inline-block; padding: 0.2rem 0.6rem; border-radius: 20px; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.03em; }
    .campaign-status.draft { background: rgba(255,255,255,0.1); color: var(--color-text-muted); }
    .campaign-status.active { background: rgba(0,230,118,0.15); color: #00E676; }
    .campaign-status.paused { background: rgba(255,183,77,0.15); color: #FFB74D; }
    .campaign-status.completed { background: rgba(100,181,246,0.15); color: #64B5F6; }

    .card-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; padding-top: 0.75rem; border-top: 1px solid var(--color-border); }
    .card-stat { text-align: center; }
    .card-stat .cs-value { font-size: 1rem; font-weight: 700; }
    .card-stat .cs-label { font-size: 0.65rem; color: var(--color-text-muted); text-transform: uppercase; }

    .card-meta { display: flex; justify-content: space-between; font-size: 0.7rem; color: var(--color-text-muted); margin-top: 0.75rem; }

    .empty-state { text-align: center; padding: 4rem 2rem; color: var(--color-text-muted); }
    .empty-state h3 { font-size: 1.2rem; color: var(--color-text-secondary); margin-bottom: 0.5rem; }

    .btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.6rem 1.2rem; border-radius: var(--radius-sm); font-size: 0.85rem; font-weight: 600; cursor: pointer; border: none; transition: var(--transition); text-decoration: none; }
    .btn-primary { background: var(--gradient-primary); color: var(--color-text-on-primary); }
    .btn-primary:hover { background: var(--gradient-primary-hover); text-decoration: none; }
    .btn-outline { background: transparent; border: 1px solid var(--color-border); color: var(--color-text-secondary); }
    .btn-outline:hover { border-color: var(--color-primary); color: var(--color-primary); text-decoration: none; }

    .back-link { display: inline-flex; align-items: center; gap: 0.5rem; color: var(--color-text-muted); font-size: 0.85rem; margin-bottom: 1.5rem; }
    .back-link:hover { color: var(--color-primary); text-decoration: none; }

    /* New Campaign Modal */
    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center; }
    .modal-overlay.active { display: flex; }
    .modal { background: var(--color-bg-elevated); border: 1px solid var(--color-border); border-radius: var(--radius-lg); padding: 2rem; width: 90%; max-width: 500px; }
    .modal h2 { font-size: 1.2rem; margin-bottom: 1.5rem; }
    .modal h2 span { color: var(--color-primary); }
    .form-group { margin-bottom: 1rem; }
    .form-group label { display: block; font-size: 0.75rem; color: var(--color-text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.4rem; }
    .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 0.6rem 0.8rem; background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-sm); color: var(--color-text); font-size: 0.85rem; font-family: var(--font-sans); }
    .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: var(--color-border-focus); }
    .form-group textarea { resize: vertical; min-height: 60px; }
    .modal-actions { display: flex; justify-content: flex-end; gap: 0.75rem; margin-top: 1.5rem; }

    .nav-bottom { position: fixed; bottom: 0; left: 0; right: 0; background: var(--color-bg-elevated); border-top: 1px solid var(--color-border); padding: 0.5rem 2rem; display: flex; gap: 1.5rem; align-items: center; font-size: 0.8rem; z-index: 100; }
    .nav-bottom a { color: var(--color-text-muted); text-decoration: none; }
    .nav-bottom a:hover { color: var(--color-primary); }
  </style>
</head>
<body>
  <div class="campaigns-page">
    <a href="/" class="back-link">← Back to Dashboard</a>

    <div class="page-header">
      <h1>Email <span>Campaigns</span></h1>
      <div style="display:flex;gap:0.75rem;flex-wrap:wrap;">
        <a href="/api/blacklist" target="_blank" class="btn btn-outline">⛔ Blacklist</a>
        <button class="btn btn-primary" onclick="openNewCampaign()">+ New Campaign</button>
      </div>
    </div>

    <div class="stats-row" id="statsRow">
      <div class="stat-card"><div class="stat-value" id="statTotal">0</div><div class="stat-label">Total Campaigns</div></div>
      <div class="stat-card"><div class="stat-value" id="statActive">0</div><div class="stat-label">Active</div></div>
      <div class="stat-card"><div class="stat-value" id="statSent">0</div><div class="stat-label">Emails Sent</div></div>
      <div class="stat-card"><div class="stat-value" id="statReplies">0</div><div class="stat-label">Replies</div></div>
      <div class="stat-card"><div class="stat-value" id="statBounces">0</div><div class="stat-label">Bounces</div></div>
    </div>

    <div id="campaignsList"></div>
  </div>

  <!-- New Campaign Modal -->
  <div class="modal-overlay" id="newCampaignModal">
    <div class="modal">
      <h2>New <span>Campaign</span></h2>
      <div class="form-group">
        <label>Campaign Name</label>
        <input type="text" id="newName" placeholder="e.g., Construction Outreach Q1">
      </div>
      <div class="form-group">
        <label>Description</label>
        <textarea id="newDesc" placeholder="Brief description of this campaign..."></textarea>
      </div>
      <div class="form-group">
        <label>Webhook URL (Make.com)</label>
        <input type="url" id="newWebhook" placeholder="https://hook.us1.make.com/...">
      </div>
      <div class="modal-actions">
        <button class="btn btn-outline" onclick="closeNewCampaign()">Cancel</button>
        <button class="btn btn-primary" onclick="createCampaign()">Create Campaign</button>
      </div>
    </div>
  </div>

  <div class="nav-bottom">
    <a href="/">Dashboard</a>
    <a href="/campaigns" style="color:var(--color-primary);">Campaigns</a>
    <a href="/import">CSV Import</a>
    <a href="/dev">Dev Console</a>
    <a href="/logout">Logout</a>
  </div>

<script>
let campaigns = [];

async function loadCampaigns() {
  try {
    const res = await fetch('/api/campaigns');
    const data = await res.json();
    campaigns = data.campaigns || [];
    renderCampaigns();
    updateStats();
  } catch (err) {
    console.error('Failed to load campaigns:', err);
  }
}

function updateStats() {
  document.getElementById('statTotal').textContent = campaigns.length;
  document.getElementById('statActive').textContent = campaigns.filter(c => c.status === 'active').length;
  document.getElementById('statSent').textContent = campaigns.reduce((sum, c) => sum + (c.stats?.emails_sent || 0), 0).toLocaleString();
  document.getElementById('statReplies').textContent = campaigns.reduce((sum, c) => sum + (c.stats?.replies_received || 0), 0).toLocaleString();
  document.getElementById('statBounces').textContent = campaigns.reduce((sum, c) => sum + (c.stats?.bounces || 0), 0).toLocaleString();
}

function renderCampaigns() {
  const container = document.getElementById('campaignsList');

  if (campaigns.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <h3>No campaigns yet</h3>
        <p>Create your first email outreach campaign to get started.</p>
        <br>
        <button class="btn btn-primary" onclick="openNewCampaign()">+ New Campaign</button>
      </div>`;
    return;
  }

  container.innerHTML = `<div class="campaigns-grid">${campaigns.map(c => {
    const replyRate = c.stats?.emails_sent > 0
      ? Math.round((c.stats.replies_received / c.stats.emails_sent) * 100)
      : 0;
    const timeAgo = getTimeAgo(c.updated_at);

    return `
      <div class="campaign-card" onclick="window.location='/campaigns/${c.id}'">
        <div class="card-header">
          <div class="card-name">${esc(c.name)}</div>
          <span class="campaign-status ${c.status}">${c.status}</span>
        </div>
        ${c.description ? `<div class="card-desc">${esc(c.description).substring(0, 120)}${c.description.length > 120 ? '...' : ''}</div>` : ''}
        <div class="card-stats">
          <div class="card-stat"><div class="cs-value">${c.stats?.total_leads || 0}</div><div class="cs-label">Leads</div></div>
          <div class="card-stat"><div class="cs-value">${c.stats?.emails_sent || 0}</div><div class="cs-label">Sent</div></div>
          <div class="card-stat"><div class="cs-value">${c.stats?.replies_received || 0}</div><div class="cs-label">Replies</div></div>
          <div class="card-stat"><div class="cs-value">${replyRate}%</div><div class="cs-label">Reply Rate</div></div>
        </div>
        <div class="card-meta">
          <span>${c.steps?.length || 0} step${(c.steps?.length || 0) !== 1 ? 's' : ''} · ${c.schedule?.frequency_minutes || 5} min interval</span>
          <span>${timeAgo}</span>
        </div>
      </div>`;
  }).join('')}</div>`;
}

function openNewCampaign() {
  document.getElementById('newCampaignModal').classList.add('active');
  document.getElementById('newName').focus();
}

function closeNewCampaign() {
  document.getElementById('newCampaignModal').classList.remove('active');
}

async function createCampaign() {
  const name = document.getElementById('newName').value.trim();
  if (!name) { alert('Campaign name is required'); return; }

  const body = {
    name,
    description: document.getElementById('newDesc').value.trim(),
    webhook_url: document.getElementById('newWebhook').value.trim()
  };

  try {
    const res = await fetch('/api/campaigns', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    const data = await res.json();
    if (data.success) {
      window.location = `/campaigns/${data.campaign.id}`;
    } else {
      alert(data.error || 'Failed to create campaign');
    }
  } catch (err) {
    alert('Error creating campaign: ' + err.message);
  }
}

function esc(str) {
  if (!str) return '';
  const d = document.createElement('div');
  d.textContent = str;
  return d.innerHTML;
}

function getTimeAgo(dateStr) {
  if (!dateStr) return '';
  const diff = Date.now() - new Date(dateStr).getTime();
  const mins = Math.floor(diff / 60000);
  if (mins < 1) return 'just now';
  if (mins < 60) return `${mins}m ago`;
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return `${hrs}h ago`;
  const days = Math.floor(hrs / 24);
  return `${days}d ago`;
}

// Keyboard: Esc to close modal
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeNewCampaign();
});

document.getElementById('newCampaignModal').addEventListener('click', e => {
  if (e.target === e.currentTarget) closeNewCampaign();
});

loadCampaigns();
</script>
</body>
</html>
