<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dev Console — FlowTier Leads</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/style.css">
  <style>
    .dev-section { margin-bottom: 32px; }
    .dev-section h2 {
      font-size: 1.125rem; font-weight: 700; margin-bottom: 16px;
      padding-bottom: 10px; border-bottom: 1px solid var(--color-border);
    }
    .dev-section h2 span { color: var(--color-primary); }

    .endpoint-card {
      background: var(--color-bg-elevated);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      padding: 20px;
      margin-bottom: 12px;
    }
    .endpoint-header {
      display: flex; align-items: center; gap: 10px; margin-bottom: 10px;
    }
    .method-badge {
      font-family: var(--font-mono); font-size: 0.6875rem; font-weight: 700;
      padding: 3px 8px; border-radius: 4px; text-transform: uppercase;
    }
    .method-badge.get { background: rgba(100,181,246,0.15); color: #64B5F6; }
    .method-badge.post { background: rgba(0,230,118,0.15); color: #00E676; }
    .method-badge.put { background: rgba(255,183,77,0.15); color: #FFB74D; }
    .method-badge.patch { background: rgba(206,147,216,0.15); color: #CE93D8; }
    .method-badge.delete { background: rgba(255,82,82,0.15); color: #FF5252; }

    .endpoint-path {
      font-family: var(--font-mono); font-size: 0.8125rem; font-weight: 600;
      color: var(--color-text);
    }
    .endpoint-desc {
      font-size: 0.8125rem; color: var(--color-text-secondary); margin-bottom: 10px;
    }

    .code-block {
      background: rgba(0,0,0,0.3); border: 1px solid var(--color-border-light);
      border-radius: var(--radius-sm); padding: 14px;
      font-family: var(--font-mono); font-size: 0.75rem;
      color: var(--color-text-secondary); overflow-x: auto;
      line-height: 1.6; white-space: pre-wrap; word-break: break-all;
    }
    .code-block .key { color: #CE93D8; }
    .code-block .str { color: #00E676; }
    .code-block .num { color: #FFB74D; }

    .webhook-config-card {
      background: var(--color-bg-elevated);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      padding: 24px;
      margin-bottom: 20px;
    }
    .webhook-url-input {
      display: flex; gap: 10px; margin-top: 10px;
    }
    .webhook-url-input input { flex: 1; }

    .test-card {
      background: var(--color-bg-elevated);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      padding: 20px;
      margin-bottom: 12px;
    }
    .test-card-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 12px;
    }
    .test-card-title {
      font-size: 0.875rem; font-weight: 700; color: var(--color-text);
    }
    .test-card-desc {
      font-size: 0.8125rem; color: var(--color-text-secondary); margin-bottom: 12px;
    }
    .test-result {
      margin-top: 12px; padding: 12px; border-radius: var(--radius-sm);
      font-family: var(--font-mono); font-size: 0.75rem;
      display: none;
    }
    .test-result.success { background: rgba(0,230,118,0.08); border: 1px solid rgba(0,230,118,0.2); color: var(--color-success); }
    .test-result.error { background: rgba(255,82,82,0.08); border: 1px solid rgba(255,82,82,0.2); color: var(--color-danger); }

    .payload-toggle {
      font-size: 0.75rem; color: var(--color-text-muted); cursor: pointer;
      background: none; border: none; font-family: var(--font-sans);
      padding: 4px 0;
    }
    .payload-toggle:hover { color: var(--color-text-secondary); }

    .tab-bar {
      display: flex; gap: 0; margin-bottom: 24px;
      border-bottom: 1px solid var(--color-border);
    }
    .tab-btn {
      padding: 10px 20px; font-size: 0.8125rem; font-weight: 600;
      color: var(--color-text-muted); background: none; border: none;
      border-bottom: 2px solid transparent; cursor: pointer;
      font-family: var(--font-sans); transition: var(--transition);
    }
    .tab-btn:hover { color: var(--color-text-secondary); }
    .tab-btn.active { color: var(--color-primary); border-bottom-color: var(--color-primary); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .field-table {
      width: 100%; border-collapse: collapse; margin-top: 10px;
    }
    .field-table th {
      text-align: left; padding: 8px 12px; font-size: 0.6875rem;
      font-weight: 700; text-transform: uppercase; letter-spacing: 0.04em;
      color: var(--color-text-muted); border-bottom: 1px solid var(--color-border);
      background: var(--color-surface);
    }
    .field-table td {
      padding: 8px 12px; font-size: 0.8125rem; color: var(--color-text-secondary);
      border-bottom: 1px solid var(--color-border-light);
    }
    .field-table td code {
      font-family: var(--font-mono); font-size: 0.75rem;
      background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 3px;
      color: var(--color-primary);
    }
  </style>
</head>
<body>
  <div class="app-shell">

    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-logo">
        <img src="/static/images/logo.webp" alt="FlowTier">
        <div class="app-label">Lead Management</div>
      </div>
      <nav class="sidebar-nav">
        <a href="/" class="nav-item"><span class="icon">&#8592;</span> Back to Dashboard</a>
        <div class="nav-section-label">Dev Console</div>
        <a href="#webhook-testing" class="nav-item active"><span class="icon">&#9889;</span> Webhook Testing</a>
        <a href="#api-docs" class="nav-item"><span class="icon">&#128196;</span> API Documentation</a>
        <a href="#data-model" class="nav-item"><span class="icon">&#128202;</span> Data Model</a>
        <a href="#make-integration" class="nav-item"><span class="icon">&#9881;</span> Make.com Guide</a>
      </nav>
      <div class="sidebar-footer">
        <a href="/logout"><span class="icon">&#10140;</span> Logout</a>
      </div>
    </aside>

    <!-- Main -->
    <main class="main-content">

      <div class="page-header">
        <h1>Dev <span>Console</span></h1>
      </div>

      <!-- ═══════════════════════════════════ -->
      <!-- WEBHOOK TESTING                     -->
      <!-- ═══════════════════════════════════ -->
      <div class="dev-section" id="webhook-testing">
        <h2>&#9889; Webhook <span>Testing</span></h2>

        <!-- Webhook Config -->
        <div class="webhook-config-card">
          <div style="font-weight:600;margin-bottom:4px;">Webhook URL</div>
          <div style="font-size:0.8125rem;color:var(--color-text-muted);margin-bottom:10px;">
            All webhook events will be sent to this URL. Use your Make.com webhook URL or any endpoint.
          </div>
          <div class="webhook-url-input">
            <input type="url" id="webhookUrl" class="form-group" placeholder="https://hook.us2.make.com/..." style="padding:10px 14px;background:var(--color-surface);border:1px solid var(--color-border);border-radius:var(--radius-sm);color:var(--color-text);font-size:0.8125rem;font-family:var(--font-sans);outline:none;">
            <button class="btn btn-primary" id="saveWebhookBtn">Save</button>
          </div>
          <div id="webhookStatus" style="font-size:0.75rem;margin-top:8px;color:var(--color-text-muted);"></div>
        </div>

        <!-- Test: Lead Created -->
        <div class="test-card">
          <div class="test-card-header">
            <div class="test-card-title">&#128203; lead_created</div>
            <button class="btn btn-primary btn-sm" onclick="testWebhook('lead_created')">Send Test</button>
          </div>
          <div class="test-card-desc">Fired when a new lead is added to the system (via API, CSV import, or manual creation).</div>
          <button class="payload-toggle" onclick="togglePayload('lead_created')">Show Payload &#9660;</button>
          <div class="code-block" id="payload_lead_created" style="display:none;"></div>
          <div class="test-result" id="result_lead_created"></div>
        </div>

        <!-- Test: Lead Stage Changed -->
        <div class="test-card">
          <div class="test-card-header">
            <div class="test-card-title">&#128260; lead_stage_changed</div>
            <button class="btn btn-primary btn-sm" onclick="testWebhook('lead_stage_changed')">Send Test</button>
          </div>
          <div class="test-card-desc">Fired when a lead's stage changes (e.g., Cold → Qualified). Includes old and new stage.</div>
          <button class="payload-toggle" onclick="togglePayload('lead_stage_changed')">Show Payload &#9660;</button>
          <div class="code-block" id="payload_lead_stage_changed" style="display:none;"></div>
          <div class="test-result" id="result_lead_stage_changed"></div>
        </div>

        <!-- Test: Lead Call Booked -->
        <div class="test-card">
          <div class="test-card-header">
            <div class="test-card-title">&#128197; lead_call_booked</div>
            <button class="btn btn-primary btn-sm" onclick="testWebhook('lead_call_booked')">Send Test</button>
          </div>
          <div class="test-card-desc">Fired when a calendar event is attached to a lead (call scheduled via Make.com or manual).</div>
          <button class="payload-toggle" onclick="togglePayload('lead_call_booked')">Show Payload &#9660;</button>
          <div class="code-block" id="payload_lead_call_booked" style="display:none;"></div>
          <div class="test-result" id="result_lead_call_booked"></div>
        </div>

        <!-- Test: Lead Note Added -->
        <div class="test-card">
          <div class="test-card-header">
            <div class="test-card-title">&#128221; lead_note_added</div>
            <button class="btn btn-primary btn-sm" onclick="testWebhook('lead_note_added')">Send Test</button>
          </div>
          <div class="test-card-desc">Fired when a note is added to a lead (call snapshots, follow-up notes, etc.).</div>
          <button class="payload-toggle" onclick="togglePayload('lead_note_added')">Show Payload &#9660;</button>
          <div class="code-block" id="payload_lead_note_added" style="display:none;"></div>
          <div class="test-result" id="result_lead_note_added"></div>
        </div>

        <!-- Test: Outreach Logged -->
        <div class="test-card">
          <div class="test-card-header">
            <div class="test-card-title">&#128232; lead_outreach_logged</div>
            <button class="btn btn-primary btn-sm" onclick="testWebhook('lead_outreach_logged')">Send Test</button>
          </div>
          <div class="test-card-desc">Fired when an outreach email/message is logged for a lead. Auto-moves Cold leads to Contacted.</div>
          <button class="payload-toggle" onclick="togglePayload('lead_outreach_logged')">Show Payload &#9660;</button>
          <div class="code-block" id="payload_lead_outreach_logged" style="display:none;"></div>
          <div class="test-result" id="result_lead_outreach_logged"></div>
        </div>

        <!-- Test: Proposal Created -->
        <div class="test-card">
          <div class="test-card-header">
            <div class="test-card-title">&#128196; proposal_created</div>
            <button class="btn btn-primary btn-sm" onclick="testWebhook('proposal_created')">Send Test</button>
          </div>
          <div class="test-card-desc">Fired when a proposal is created in the Proposal Builder. Includes lead_id if linked to a CRM lead.</div>
          <button class="payload-toggle" onclick="togglePayload('proposal_created')">Show Payload &#9660;</button>
          <div class="code-block" id="payload_proposal_created" style="display:none;"></div>
          <div class="test-result" id="result_proposal_created"></div>
        </div>

        <!-- Test: Proposal Signed -->
        <div class="test-card">
          <div class="test-card-header">
            <div class="test-card-title">&#9989; proposal_signed</div>
            <button class="btn btn-primary btn-sm" onclick="testWebhook('proposal_signed')">Send Test</button>
          </div>
          <div class="test-card-desc">Fired when a client signs a proposal. Includes lead_id, signature data, and Stripe payment link.</div>
          <button class="payload-toggle" onclick="togglePayload('proposal_signed')">Show Payload &#9660;</button>
          <div class="code-block" id="payload_proposal_signed" style="display:none;"></div>
          <div class="test-result" id="result_proposal_signed"></div>
        </div>

        <!-- Test: Campaign Email Due -->
        <div class="test-card">
          <div class="test-card-header">
            <div class="test-card-title">&#128233; campaign_email_due</div>
            <button class="btn btn-primary btn-sm" onclick="testWebhook('campaign_email_due')">Send Test</button>
          </div>
          <div class="test-card-desc">Fired when a campaign email is due to be sent. Contains lead data, email template, step info, and callback URLs. <strong>Make.com should respond with a JSON body</strong> containing the actual email sent (status, subject_sent, email_sent, from_email). The system uses the webhook response to confirm delivery and log the real email content. You can also still use the callback_urls separately if preferred.</div>
          <button class="payload-toggle" onclick="togglePayload('campaign_email_due')">Show Payload &#9660;</button>
          <div class="code-block" id="payload_campaign_email_due" style="display:none;"></div>
          <div class="test-result" id="result_campaign_email_due"></div>
        </div>

        <!-- Test: Campaign Reply Received -->
        <div class="test-card">
          <div class="test-card-header">
            <div class="test-card-title">&#128172; campaign_reply_received</div>
            <button class="btn btn-primary btn-sm" onclick="testWebhook('campaign_reply_received')">Send Test</button>
          </div>
          <div class="test-card-desc">Fired when a lead replies to a campaign email. Sequence is auto-paused for this lead.</div>
          <button class="payload-toggle" onclick="togglePayload('campaign_reply_received')">Show Payload &#9660;</button>
          <div class="code-block" id="payload_campaign_reply_received" style="display:none;"></div>
          <div class="test-result" id="result_campaign_reply_received"></div>
        </div>

        <!-- Test: Campaign Bounce -->
        <div class="test-card">
          <div class="test-card-header">
            <div class="test-card-title">&#9888; campaign_email_bounced</div>
            <button class="btn btn-primary btn-sm" onclick="testWebhook('campaign_email_bounced')">Send Test</button>
          </div>
          <div class="test-card-desc">Fired when an email bounces. Lead is marked as bounced and removed from the sequence.</div>
          <button class="payload-toggle" onclick="togglePayload('campaign_email_bounced')">Show Payload &#9660;</button>
          <div class="code-block" id="payload_campaign_email_bounced" style="display:none;"></div>
          <div class="test-result" id="result_campaign_email_bounced"></div>
        </div>

        <!-- Webhook History -->
        <div style="margin-top:24px;">
          <h3 style="font-size:0.9375rem;font-weight:700;margin-bottom:12px;">Webhook Delivery History</h3>
          <p style="font-size:0.8125rem;color:var(--color-text-secondary);margin-bottom:12px;">Shows the last 50 webhook deliveries with status and response details.</p>
          <button class="btn btn-secondary btn-sm" onclick="loadWebhookHistory()" style="margin-bottom:12px;">&#8635; Refresh History</button>
          <div id="webhookHistoryList" style="max-height:300px;overflow-y:auto;"></div>
        </div>
      </div>

      <!-- ═══════════════════════════════════ -->
      <!-- API DOCUMENTATION                   -->
      <!-- ═══════════════════════════════════ -->
      <div class="dev-section" id="api-docs">
        <h2>&#128196; API <span>Documentation</span></h2>

        <div style="font-size:0.8125rem;color:var(--color-text-secondary);margin-bottom:20px;line-height:1.7;">
          Base URL: <code style="font-family:var(--font-mono);background:rgba(0,0,0,0.3);padding:2px 8px;border-radius:4px;color:var(--color-primary);">https://leads.flowtier.io</code><br>
          All endpoints accept and return JSON. Authentication is via session cookie (dashboard) or <code style="font-family:var(--font-mono);background:rgba(0,0,0,0.3);padding:2px 8px;border-radius:4px;color:var(--color-primary);">X-API-Key</code> header (external).
          If no API key is configured, all <code>/api/</code> endpoints are open for Make.com integration.
        </div>

        <div class="tab-bar">
          <button class="tab-btn active" onclick="switchTab('leads')">Leads CRUD</button>
          <button class="tab-btn" onclick="switchTab('notes')">Notes</button>
          <button class="tab-btn" onclick="switchTab('outreach')">Outreach</button>
          <button class="tab-btn" onclick="switchTab('attachments')">Attachments</button>
          <button class="tab-btn" onclick="switchTab('calendar')">Calendar</button>
          <button class="tab-btn" onclick="switchTab('bulk')">Bulk Actions</button>
          <button class="tab-btn" onclick="switchTab('import')">Import / Export</button>
          <button class="tab-btn" onclick="switchTab('config')">Config</button>
          <button class="tab-btn" onclick="switchTab('proposals')">Proposals</button>
          <button class="tab-btn" onclick="switchTab('campaigns')">Campaigns</button>
          <button class="tab-btn" onclick="switchTab('conversations')">Conversations</button>
          <button class="tab-btn" onclick="switchTab('blacklist')">Blacklist</button>
        </div>

        <!-- LEADS CRUD TAB -->
        <div class="tab-content active" id="tab-leads">
          <div class="endpoint-card">
            <div class="endpoint-header">
              <span class="method-badge get">GET</span>
              <span class="endpoint-path">/api/leads</span>
            </div>
            <div class="endpoint-desc">List all leads with optional filters.</div>
            <table class="field-table">
              <thead><tr><th>Query Param</th><th>Type</th><th>Description</th></tr></thead>
              <tbody>
                <tr><td><code>industry</code></td><td>string</td><td>Filter by industry name</td></tr>
                <tr><td><code>stage</code></td><td>string</td><td>Filter by stage ID (cold, contacted, qualified, call_booked, proposal_sent, won, lost)</td></tr>
                <tr><td><code>tag</code></td><td>string</td><td>Filter by tag name</td></tr>
                <tr><td><code>search</code></td><td>string</td><td>Full-text search across name, company, email, tags, details</td></tr>
                <tr><td><code>source</code></td><td>string</td><td>Filter by lead source</td></tr>
                <tr><td><code>sort</code></td><td>string</td><td>Sort field (default: updated_at)</td></tr>
                <tr><td><code>order</code></td><td>string</td><td>asc or desc (default: desc)</td></tr>
              </tbody>
            </table>
          </div>

          <div class="endpoint-card">
            <div class="endpoint-header">
              <span class="method-badge get">GET</span>
              <span class="endpoint-path">/api/leads/:id</span>
            </div>
            <div class="endpoint-desc">Get a single lead by ID. Returns the full lead object including notes and activity.</div>
          </div>

          <div class="endpoint-card">
            <div class="endpoint-header">
              <span class="method-badge post">POST</span>
              <span class="endpoint-path">/api/leads</span>
            </div>
            <div class="endpoint-desc">Create a new lead. This is the primary endpoint for Make.com to send leads.</div>
            <div class="code-block">{
  "company_name": "Brightside Dental",
  "contact_name": "Sarah Mitchell",
  "emails": ["sarah@brightsidedental.com"],
  "phones": ["+1 555-123-4567"],
  "website": "https://brightsidedental.com",
  "industry": "Dental",
  "company_size": "11-50",
  "lead_source": "make.com",
  "tags": ["high-priority", "dental"],
  "stage": "cold",
  "deal_value": 5000,
  "details": "Enrichment data goes here..."
}</div>
          </div>

          <div class="endpoint-card">
            <div class="endpoint-header">
              <span class="method-badge put">PUT</span>
              <span class="endpoint-path">/api/leads/:id</span>
            </div>
            <div class="endpoint-desc">Full update of a lead. Replaces all fields. Preserves notes and activity.</div>
          </div>

          <div class="endpoint-card">
            <div class="endpoint-header">
              <span class="method-badge patch">PATCH</span>
              <span class="endpoint-path">/api/leads/:id</span>
            </div>
            <div class="endpoint-desc">Partial update. Only send the fields you want to change. Stage changes are tracked in activity.</div>
            <div class="code-block">// Example: Move lead to "qualified" stage
PATCH /api/leads/abc-123
{ "stage": "qualified", "deal_value": 8000 }</div>
          </div>

          <div class="endpoint-card">
            <div class="endpoint-header">
              <span class="method-badge delete">DELETE</span>
              <span class="endpoint-path">/api/leads/:id</span>
            </div>
            <div class="endpoint-desc">Permanently delete a lead.</div>
          </div>

          <div class="endpoint-card" style="border-left:3px solid #10b981;">
            <div class="endpoint-header">
              <span class="method-badge get">GET</span>
              <span class="endpoint-path">/api/leads/lookup?email=...</span>
            </div>
            <div class="endpoint-desc"><strong>Public endpoint (no auth required, CORS enabled)</strong> — Look up a lead by email address. Used by the Proposal Builder to auto-link proposals to existing leads. Returns only basic info (no sensitive data).</div>
            <table class="field-table">
              <thead><tr><th>Query Param</th><th>Type</th><th>Description</th></tr></thead>
              <tbody>
                <tr><td><code>email</code></td><td>string</td><td>Email address to search for (case-insensitive, handles nested arrays)</td></tr>
              </tbody>
            </table>
            <div class="code-block">// Response when found:
{
  "found": true,
  "lead_id": "abc-123-def-456",
  "contact_name": "Sarah Mitchell",
  "company_name": "Brightside Dental",
  "stage": "qualified",
  "human_mode": false
}

// Response when not found:
{ "found": false }</div>
          </div>

          <div class="endpoint-card" style="border-left:3px solid #f59e0b;">
            <div class="endpoint-header">
              <span class="method-badge get">GET</span>
              <span class="endpoint-path">/api/leads/by-email?email=...</span>
              <span style="color:#f59e0b;font-size:0.75rem;margin-left:8px;">EMAIL EXACT MATCH</span>
            </div>
            <div class="endpoint-desc"><strong>Authenticated endpoint</strong> &mdash; Search for a lead by exact email match. Returns the <strong>full lead object</strong> (all fields, notes, activity, etc.) when found. The match is case-insensitive and works even if the lead has multiple emails &mdash; matching any one of them is enough. Returns at most one lead.</div>
            <table class="field-table">
              <thead><tr><th>Query Param</th><th>Type</th><th>Description</th></tr></thead>
              <tbody>
                <tr><td><code>email</code></td><td>string</td><td>Exact email address to match (case-insensitive). Must be a valid email with @.</td></tr>
              </tbody>
            </table>
            <div class="code-block">// Request:
GET /api/leads/by-email?email=sarah@brightsidedental.com

// Response when found (full lead object):
{
  "found": true,
  "lead": {
    "id": "abc-123-def-456",
    "company_name": "Brightside Dental",
    "contact_name": "Sarah Mitchell",
    "emails": ["sarah@brightsidedental.com", "info@brightsidedental.com"],
    "phones": ["+1 555-123-4567"],
    "stage": "qualified",
    "human_mode": false,
    "lead_score": 65,
    "deal_value": 5000,
    ... // all lead fields
  }
}

// Response when not found:
{ "found": false, "lead": null }

// Response on invalid email:
// HTTP 400
{ "error": "Valid email parameter is required" }</div>
          </div>

          <div class="endpoint-card" style="border-left:3px solid #8b5cf6;">
            <div class="endpoint-header">
              <span class="method-badge patch">PATCH</span>
              <span class="endpoint-path">/api/leads/:id</span>
              <span style="color:#8b5cf6;font-size:0.75rem;margin-left:8px;">PROPOSAL INTEGRATION</span>
            </div>
            <div class="endpoint-desc">Link a proposal URL to a lead. After a proposal is created in the Proposal Builder, Make.com can use the <code>lead_id</code> from the webhook to update the lead with the proposal URL.</div>
            <div class="code-block">// Make.com scenario: After proposal_created webhook
PATCH /api/leads/{{lead_id}}
{
  "proposal_url": "https://proposals.flowtier.io/brightside-dental",
  "stage": "proposal_sent"
}</div>
          </div>
        </div>

        <!-- NOTES TAB -->
        <div class="tab-content" id="tab-notes">
          <div class="endpoint-card">
            <div class="endpoint-header">
              <span class="method-badge post">POST</span>
              <span class="endpoint-path">/api/leads/:id/notes</span>
            </div>
            <div class="endpoint-desc">Add a rich text note to a lead. Supports HTML content with images. Types: note, call_snapshot, follow_up, research.</div>
            <div class="code-block">{
  "title": "Discovery Call - Key Takeaways",
  "content": "&lt;h2&gt;Key Takeaways&lt;/h2&gt;&lt;p&gt;They need AI chatbot + appointment booking...&lt;/p&gt;",
  "type": "call_snapshot"
}

// Types: note, call_snapshot, follow_up, research</div>
          </div>

          <div class="endpoint-card">
            <div class="endpoint-header">
              <span class="method-badge put">PUT</span>
              <span class="endpoint-path">/api/leads/:id/notes/:noteId</span>
            </div>
            <div class="endpoint-desc">Update an existing note (title, type, content).</div>
          </div>

          <div class="endpoint-card">
            <div class="endpoint-header">
              <span class="method-badge delete">DELETE</span>
              <span class="endpoint-path">/api/leads/:id/notes/:noteId</span>
            </div>
            <div class="endpoint-desc">Delete a specific note from a lead.</div>
          </div>

          <div class="endpoint-card">
            <div class="endpoint-header">
              <span class="method-badge post">POST</span>
              <span class="endpoint-path">/api/upload/image</span>
            </div>
            <div class="endpoint-desc">Upload an image for use in rich text notes. Use multipart/form-data with field name <code>image</code>. Returns <code>{ "url": "/uploads/..." }</code>.</div>
          </div>
        </div>

        <!-- OUTREACH TAB -->
        <div class="tab-content" id="tab-outreach">
          <div class="endpoint-card">
            <div class="endpoint-header">
              <span class="method-badge post">POST</span>
              <span class="endpoint-path">/api/leads/:id/outreach</span>
            </div>
            <div class="endpoint-desc">Log an outreach interaction. Requires <code>direction</code> and <code>body</code>. Include <code>from_email</code> and <code>to_email</code> to track which email addresses are involved. Auto-moves Cold leads to Contacted when direction is "sent".</div>
            <div class="code-block">{
  "direction": "sent",
  "channel": "email",
  "subject": "Introduction - AI Automation for Your Business",
  "body": "Hi Sarah, I wanted to reach out about how we can help...",
  "from_email": "tulio@flowtier.io",
  "to_email": "sarah@brightsidedental.com"
}

// direction: "sent" or "received" (required)
// body: message content (required)
// channel: "email", "sms", "call", "instagram", "other"
// from_email: sender's email address
// to_email: recipient's email address</div>
          </div>

          <div class="endpoint-card">
            <div class="endpoint-header">
              <span class="method-badge get">GET</span>
              <span class="endpoint-path">/api/leads/:id/outreach</span>
            </div>
            <div class="endpoint-desc">Get all outreach for a lead, <strong>grouped by email thread</strong>. Each thread contains the full conversation history for one email address, sorted chronologically.</div>
            <div class="code-block">// Response:
{
  "outreach": [
    {
      "email": "sarah@brightsidedental.com",
      "message_count": 4,
      "last_message_at": "2026-02-27T15:30:00.000Z",
      "messages": [
        {
          "direction": "sent",
          "channel": "email",
          "subject": "Introduction",
          "body": "Hi Sarah...",
          "from_email": "tulio@flowtier.io",
          "to_email": "sarah@brightsidedental.com",
          "timestamp": "2026-02-25T10:00:00.000Z"
        },
        {
          "direction": "received",
          "channel": "email",
          "subject": "Re: Introduction",
          "body": "Thanks for reaching out...",
          "from_email": "sarah@brightsidedental.com",
          "to_email": "tulio@flowtier.io",
          "timestamp": "2026-02-26T09:00:00.000Z"
        }
      ]
    },
    {
      "email": "info@brightsidedental.com",
      "message_count": 1,
      "last_message_at": "2026-02-20T12:00:00.000Z",
      "messages": [ ... ]
    }
  ]
}</div>
          </div>

          <div class="endpoint-card" style="border-left:3px solid #f59e0b;">
            <div class="endpoint-header">
              <span class="method-badge get">GET</span>
              <span class="endpoint-path">/api/outreach/by-email?email=...</span>
              <span style="color:#f59e0b;font-size:0.75rem;margin-left:8px;">CONVERSATION SEARCH</span>
            </div>
            <div class="endpoint-desc"><strong>Search all outreach history for a specific email address.</strong> Finds every sent/received message involving that email across all leads. Returns the full conversation thread plus basic lead info. Exact match, case-insensitive.</div>
            <table class="field-table">
              <thead><tr><th>Query Param</th><th>Type</th><th>Description</th></tr></thead>
              <tbody>
                <tr><td><code>email</code></td><td>string</td><td>Exact email address to search for in from_email and to_email fields</td></tr>
              </tbody>
            </table>
            <div class="code-block">// Request:
GET /api/outreach/by-email?email=sarah@brightsidedental.com

// Response:
{
  "email": "sarah@brightsidedental.com",
  "found": true,
  "leads": [
    {
      "lead_id": "abc-123",
      "contact_name": "Sarah Mitchell",
      "company_name": "Brightside Dental",
      "stage": "qualified",
      "human_mode": false,
      "messages": [
        {
          "direction": "sent",
          "channel": "email",
          "subject": "Introduction",
          "body": "Hi Sarah...",
          "from_email": "tulio@flowtier.io",
          "to_email": "sarah@brightsidedental.com",
          "timestamp": "2026-02-25T10:00:00.000Z"
        },
        ...
      ],
      "message_count": 4,
      "last_message_at": "2026-02-27T15:30:00.000Z"
    }
  ],
  "total_leads": 1,
  "total_messages": 4
}</div>
          </div>

          <div class="endpoint-card">
            <div class="endpoint-header">
              <span class="method-badge delete">DELETE</span>
              <span class="endpoint-path">/api/leads/:id/outreach/:outreachId</span>
            </div>
            <div class="endpoint-desc">Delete an outreach entry by its internal ID.</div>
          </div>
        </div>

        <!-- ATTACHMENTS TAB -->
        <div class="tab-content" id="tab-attachments">
          <div class="endpoint-card">
            <div class="endpoint-header">
              <span class="method-badge post">POST</span>
              <span class="endpoint-path">/api/leads/:id/attachments</span>
            </div>
            <div class="endpoint-desc">Upload a file attachment to a lead. Use multipart/form-data with field name <code>file</code>.</div>
          </div>

          <div class="endpoint-card">
            <div class="endpoint-header">
              <span class="method-badge delete">DELETE</span>
              <span class="endpoint-path">/api/leads/:id/attachments/:attId</span>
            </div>
            <div class="endpoint-desc">Delete a file attachment from a lead.</div>
          </div>
        </div>

        <!-- CALENDAR TAB -->
        <div class="tab-content" id="tab-calendar">
          <div class="endpoint-card">
            <div class="endpoint-header">
              <span class="method-badge post">POST</span>
              <span class="endpoint-path">/api/leads/:id/calendar</span>
            </div>
            <div class="endpoint-desc">Attach a calendar event to a lead. Use this from Make.com when a Google Calendar event is created, or add events manually from the lead profile.</div>
            <div class="code-block">{
  "event_id": "abc123xyz",
  "title": "Discovery Call with Brightside Dental",
  "event_date": "2026-03-01",
  "start_time": "2026-03-01T14:00:00Z",
  "end_time": "2026-03-01T14:30:00Z",
  "meet_link": "https://meet.google.com/abc-defg-hij",
  "description": "Discuss AI chatbot implementation",
  "attendees": ["sarah@brightsidedental.com", "tulio@flowtier.io"]
}</div>
            <table class="schema-table" style="margin-top:12px;">
              <thead><tr><th>Field</th><th>Type</th><th>Description</th></tr></thead>
              <tbody>
                <tr><td><code>event_id</code></td><td>string</td><td>Google Calendar event ID (optional, used for "View in Calendar" link)</td></tr>
                <tr><td><code>title</code></td><td>string</td><td>Event title. Defaults to "Call with [contact name]" if empty</td></tr>
                <tr><td><code>event_date</code></td><td>string</td><td><strong>Event date</strong> in YYYY-MM-DD format (e.g., "2026-03-01")</td></tr>
                <tr><td><code>start_time</code></td><td>string</td><td>Start time as ISO datetime or HH:MM</td></tr>
                <tr><td><code>end_time</code></td><td>string</td><td>End time as ISO datetime or HH:MM</td></tr>
                <tr><td><code>meet_link</code></td><td>string</td><td>Google Meet / Zoom / video call URL</td></tr>
                <tr><td><code>description</code></td><td>string</td><td>Event description or agenda</td></tr>
                <tr><td><code>attendees</code></td><td>string[]</td><td>Array of attendee email addresses</td></tr>
              </tbody>
            </table>
            <div class="endpoint-desc" style="margin-top:12px;"><strong>Side effects:</strong> Auto-changes stage to "Call Booked" if lead is Cold/Contacted/Qualified. Fires <code>lead_call_booked</code> webhook.</div>
          </div>
        </div>

        <!-- BULK TAB -->
        <div class="tab-content" id="tab-bulk">
          <div class="endpoint-card">
            <div class="endpoint-header">
              <span class="method-badge post">POST</span>
              <span class="endpoint-path">/api/leads/bulk/stage</span>
            </div>
            <div class="endpoint-desc">Change the stage of multiple leads at once.</div>
            <div class="code-block">{ "ids": ["id-1", "id-2", "id-3"], "stage": "qualified" }</div>
          </div>

          <div class="endpoint-card">
            <div class="endpoint-header">
              <span class="method-badge post">POST</span>
              <span class="endpoint-path">/api/leads/bulk/delete</span>
            </div>
            <div class="endpoint-desc">Delete multiple leads at once.</div>
            <div class="code-block">{ "ids": ["id-1", "id-2", "id-3"] }</div>
          </div>

          <div class="endpoint-card">
            <div class="endpoint-header">
              <span class="method-badge post">POST</span>
              <span class="endpoint-path">/api/leads/bulk/tag</span>
            </div>
            <div class="endpoint-desc">Add or remove a tag from multiple leads.</div>
            <div class="code-block">// Add tag
{ "ids": ["id-1", "id-2"], "tag": "high-priority" }

// Remove tag
{ "ids": ["id-1", "id-2"], "tag": "high-priority", "action": "remove" }</div>
          </div>
        </div>

        <!-- IMPORT/EXPORT TAB -->
        <div class="tab-content" id="tab-import">
          <div class="endpoint-card">
            <div class="endpoint-header">
              <span class="method-badge get">GET</span>
              <span class="endpoint-path">/api/export/csv</span>
            </div>
            <div class="endpoint-desc">Export all leads as CSV. Supports optional <code>industry</code> and <code>stage</code> query filters.</div>
          </div>

          <div class="endpoint-card">
            <div class="endpoint-header">
              <span class="method-badge post">POST</span>
              <span class="endpoint-path">/api/import/csv</span>
            </div>
            <div class="endpoint-desc">Import leads from a CSV file. Upload as multipart form data with field name <code>file</code>.</div>
            <div class="code-block">// Required CSV headers (flexible matching):
Company Name, Contact Name, Emails, Phones, Website, LinkedIn,
Address, Industry, Company Size, Revenue Estimate, Lead Source,
Tags, Stage, Assigned To, Deal Value, Details

// Emails and phones can be semicolon-separated for multiple values
// Tags can be semicolon-separated</div>
          </div>

          <div class="endpoint-card">
            <div class="endpoint-header">
              <span class="method-badge post">POST</span>
              <span class="endpoint-path">/api/import/json</span>
            </div>
            <div class="endpoint-desc">Import one or more leads as JSON. Accepts a single object or an array of objects.</div>
          </div>
        </div>

        <!-- CONFIG TAB -->
        <div class="tab-content" id="tab-config">
          <div class="endpoint-card">
            <div class="endpoint-header">
              <span class="method-badge get">GET</span>
              <span class="endpoint-path">/api/stages</span>
            </div>
            <div class="endpoint-desc">Get all pipeline stages with their IDs, labels, colors, and descriptions.</div>
          </div>

          <div class="endpoint-card">
            <div class="endpoint-header">
              <span class="method-badge get">GET</span>
              <span class="endpoint-path">/api/industries</span>
            </div>
            <div class="endpoint-desc">Get the list of industry categories.</div>
          </div>

          <div class="endpoint-card">
            <div class="endpoint-header">
              <span class="method-badge post">POST</span>
              <span class="endpoint-path">/api/industries</span>
            </div>
            <div class="endpoint-desc">Update the list of industries.</div>
            <div class="code-block">{ "industries": ["Dental", "Healthcare", "Real Estate", "Custom Industry"] }</div>
          </div>

          <div class="endpoint-card">
            <div class="endpoint-header">
              <span class="method-badge get">GET</span>
              <span class="endpoint-path">/api/stats</span>
            </div>
            <div class="endpoint-desc">Get pipeline statistics: total leads, deal values by stage, leads by industry.</div>
          </div>

          <div class="endpoint-card">
            <div class="endpoint-header">
              <span class="method-badge get">GET</span>
              <span class="endpoint-path">/api/webhook-config</span>
            </div>
            <div class="endpoint-desc">Get the current webhook URL.</div>
          </div>

          <div class="endpoint-card">
            <div class="endpoint-header">
              <span class="method-badge post">POST</span>
              <span class="endpoint-path">/api/webhook-config</span>
            </div>
            <div class="endpoint-desc">Set the webhook URL.</div>
            <div class="code-block">{ "url": "https://hook.us2.make.com/your-webhook-id" }</div>
          </div>
        </div>

        <!-- PROPOSALS INTEGRATION TAB -->
        <div class="tab-content" id="tab-proposals">
          <div style="padding:12px 0 8px;color:var(--color-text-muted);font-size:0.85rem;">
            <strong style="color:#8b5cf6;">Lead Manager ↔ Proposal Builder Integration</strong><br>
            The two systems communicate via <code>lead_id</code>. When a proposal is created from a lead, the lead_id is passed to the Proposal Builder and included in all webhook payloads.
          </div>

          <div class="endpoint-card" style="border-left:3px solid #8b5cf6;">
            <div class="endpoint-header">
              <span style="color:#8b5cf6;font-weight:700;">FLOW</span>
              <span class="endpoint-path">Lead → Proposal → Webhook → Lead Update</span>
            </div>
            <div class="endpoint-desc">Complete integration flow between Lead Manager and Proposal Builder:</div>
            <div class="code-block">1. User clicks "Create Proposal" on a lead profile
   → Opens proposals.flowtier.io/builder?lead_id=xxx&client_name=...&client_email=...

2. Proposal Builder stores lead_id internally (hidden from client)
   → lead_id is included in buildJSON() output

3. When proposal is created, webhook fires to Make.com:
   Event: proposal_created
   Payload includes: lead_id, proposal_url, client info, pricing

4. Make.com scenario receives webhook and:
   a) Updates lead stage: PATCH /api/leads/{{lead_id}} { "stage": "proposal_sent", "proposal_url": "..." }
   b) Sends email notification to client
   c) Creates follow-up task

5. When proposal is signed, webhook fires:
   Event: proposal_signed
   Payload includes: lead_id, signature, payment_link

6. Make.com updates lead: PATCH /api/leads/{{lead_id}} { "stage": "won" }</div>
          </div>

          <div class="endpoint-card">
            <div class="endpoint-header">
              <span class="method-badge get">GET</span>
              <span class="endpoint-path">/api/leads/lookup?email=...</span>
            </div>
            <div class="endpoint-desc"><strong>Public, no auth, CORS enabled.</strong> Auto-matches an email to an existing lead. Used by the Proposal Builder when creating standalone proposals — if you type an email that exists in the CRM, the system auto-links the proposal to that lead.</div>
            <div class="code-block">// Request:
GET https://leads.flowtier.io/api/leads/lookup?email=sarah@brightsidedental.com

// Response (found):
{
  "found": true,
  "lead_id": "abc-123-def-456",
  "contact_name": "Sarah Mitchell",
  "company_name": "Brightside Dental",
  "stage": "qualified"
}

// Response (not found):
{ "found": false }</div>
          </div>

          <div class="endpoint-card">
            <div class="endpoint-header">
              <span style="color:#f59e0b;font-weight:700;">WEBHOOK</span>
              <span class="endpoint-path">proposal_created / proposal_updated / proposal_signed</span>
            </div>
            <div class="endpoint-desc">All proposal webhook payloads now include <code>lead_id</code> when the proposal was created from a lead or auto-matched by email.</div>
            <div class="code-block">// proposal_created webhook payload:
{
  "event": "proposal_created",
  "proposal_url": "https://proposals.flowtier.io/brightside-dental",
  "slug": "brightside-dental",
  "proposal_id": "PROP-001",
  "lead_id": "abc-123-def-456",   // ← NEW: Use this to update the lead
  "client": {
    "name": "Sarah Mitchell",
    "company": "Brightside Dental",
    "email": "sarah@brightsidedental.com",
    "phone": "+1 555-123-4567"
  },
  "project_name": "AI Voice Assistant",
  "pricing": {
    "currency": "usd",
    "due_now_cents": 150000,
    "total_setup_cents": 250000,
    "total_monthly_cents": 49900
  },
  "created_date": "2026-02-26"
}

// proposal_signed webhook payload:
{
  "event": "proposal_signed",
  "proposal_url": "https://proposals.flowtier.io/brightside-dental",
  "slug": "brightside-dental",
  "proposal_id": "PROP-001",
  "lead_id": "abc-123-def-456",   // ← NEW
  "client": { ... },
  "signature": { "name": "Sarah Mitchell", "date": "2026-02-26T..." },
  "payment_link": "https://checkout.stripe.com/...",
  "amount_due": { "cents": 150000, "formatted": "$1500.00", "currency": "USD" }
}</div>
          </div>

          <div class="endpoint-card">
            <div class="endpoint-header">
              <span style="color:#10b981;font-weight:700;">MAKE.COM</span>
              <span class="endpoint-path">Recommended Scenario</span>
            </div>
            <div class="endpoint-desc">After receiving a <code>proposal_created</code> webhook, create a Make.com scenario that updates the lead:</div>
            <div class="code-block">// Make.com HTTP Module:
Method: PATCH
URL: https://leads.flowtier.io/api/leads/{{lead_id}}
Headers: { "Content-Type": "application/json" }
Body:
{
  "proposal_url": "{{proposal_url}}",
  "stage": "proposal_sent"
}

// This will:
// 1. Store the proposal URL on the lead profile
// 2. Move the lead to "Proposal Sent" stage
// 3. The proposal will appear on the lead's detail page</div>
          </div>
        </div>

        <!-- CAMPAIGNS TAB -->
        <div class="tab-content" id="tab-campaigns">
          <div class="endpoint-card">
            <div class="endpoint-header">
              <span class="method-badge post">POST</span>
              <span class="endpoint-path">/api/campaigns</span>
            </div>
            <div class="endpoint-desc">Create a new email campaign.</div>
            <div class="code-block">{
  "name": "Construction Outreach Q1",
  "description": "Cold outreach to construction companies",
  "webhook_url": "https://hook.us1.make.com/abc123"
}</div>
          </div>

          <div class="endpoint-card">
            <div class="endpoint-header">
              <span class="method-badge get">GET</span>
              <span class="endpoint-path">/api/campaigns</span>
            </div>
            <div class="endpoint-desc">List all campaigns with stats.</div>
          </div>

          <div class="endpoint-card">
            <div class="endpoint-header">
              <span class="method-badge get">GET</span>
              <span class="endpoint-path">/api/campaigns/:id</span>
            </div>
            <div class="endpoint-desc">Get full campaign details including leads, steps, schedule, and stats.</div>
          </div>

          <div class="endpoint-card">
            <div class="endpoint-header">
              <span class="method-badge patch">PATCH</span>
              <span class="endpoint-path">/api/campaigns/:id</span>
            </div>
            <div class="endpoint-desc">Update campaign settings (name, description, webhook_url, schedule).</div>
            <div class="code-block">{
  "name": "Updated Name",
  "schedule": {
    "frequency_minutes": 5,
    "daily_limit": 50,
    "timezone": "America/New_York",
    "days_of_week": [1, 2, 3, 4, 5],
    "time_windows": [
      { "start": "09:00", "end": "12:00" },
      { "start": "14:00", "end": "17:00" }
    ]
  }
}</div>
          </div>

          <div class="endpoint-card">
            <div class="endpoint-header">
              <span class="method-badge delete">DELETE</span>
              <span class="endpoint-path">/api/campaigns/:id</span>
            </div>
            <div class="endpoint-desc">Delete a campaign.</div>
          </div>

          <div class="endpoint-card">
            <div class="endpoint-header">
              <span class="method-badge post">POST</span>
              <span class="endpoint-path">/api/campaigns/:id/steps</span>
            </div>
            <div class="endpoint-desc">Add or update email sequence steps. Each step has a subject template, body template, delay, and active flag.</div>
            <div class="code-block">{
  "steps": [
    {
      "step_number": 1,
      "subject_template": "{{company_name}} - AI Automation Opportunity",
      "body_template": "Hi {{contact_name}}, I noticed {{company_name}} is growing fast in {{industry}}...",
      "delay_days": 0,
      "active": true
    },
    {
      "step_number": 2,
      "subject_template": "Re: {{company_name}} - Quick follow-up",
      "body_template": "Hi {{first_name}}, just following up on my previous email...",
      "delay_days": 3,
      "active": true
    }
  ]
}</div>
          </div>

          <div class="endpoint-card">
            <div class="endpoint-header">
              <span class="method-badge post">POST</span>
              <span class="endpoint-path">/api/campaigns/:id/leads</span>
            </div>
            <div class="endpoint-desc">Import leads into a campaign by their IDs.</div>
            <div class="code-block">{ "lead_ids": ["uuid-1", "uuid-2", "uuid-3"] }</div>
          </div>

          <div class="endpoint-card">
            <div class="endpoint-header">
              <span class="method-badge delete">DELETE</span>
              <span class="endpoint-path">/api/campaigns/:id/leads/:leadId</span>
            </div>
            <div class="endpoint-desc">Remove a lead from a campaign.</div>
          </div>

          <div class="endpoint-card">
            <div class="endpoint-header">
              <span class="method-badge post">POST</span>
              <span class="endpoint-path">/api/campaigns/:id/start</span>
            </div>
            <div class="endpoint-desc">Start or resume a campaign. The scheduler will begin sending webhooks according to the schedule.</div>
          </div>

          <div class="endpoint-card">
            <div class="endpoint-header">
              <span class="method-badge post">POST</span>
              <span class="endpoint-path">/api/campaigns/:id/pause</span>
            </div>
            <div class="endpoint-desc">Pause an active campaign. No more webhooks will be sent until resumed.</div>
          </div>

          <div class="endpoint-card">
            <div class="endpoint-header">
              <span class="method-badge post">POST</span>
              <span class="endpoint-path">/api/campaigns/:id/clone</span>
            </div>
            <div class="endpoint-desc">Clone a campaign with all its steps and settings. Leads are not copied.</div>
          </div>

          <div class="endpoint-card">
            <div class="endpoint-header">
              <span class="method-badge post">POST</span>
              <span class="endpoint-path">/api/campaigns/:id/log-send</span>
            </div>
            <div class="endpoint-desc"><strong>Callback from Make.com (optional)</strong> — Log that an email was successfully sent. <em>Note: You can also use the webhook response instead of this callback.</em> This marks the lead as "sent" for the current step and records the email in outreach history.</div>
            <div class="code-block">{
  "lead_id": "uuid-of-lead",
  "step_number": 1,
  "subject": "Rodrigues Flooring - AI Automation Opportunity",
  "body": "Hi Lenny, I noticed Rodrigues Flooring is growing fast...",
  "from_email": "tulio@flowtier.io"
}

// --- OR use Webhook Response (preferred) ---
// When Make.com receives campaign_email_due, respond with:
{
  "status": "sent",
  "subject_sent": "Rodrigues Flooring - AI Automation Opportunity",
  "email_sent": "Hi Lenny, I noticed Rodrigues Flooring is growing fast...",
  "from_email": "tulio@flowtier.io"
}
// The system will automatically log the send and
// record the actual AI-personalized email content.</div>
          </div>

          <div class="endpoint-card">
            <div class="endpoint-header">
              <span class="method-badge post">POST</span>
              <span class="endpoint-path">/api/campaigns/:id/reply</span>
            </div>
            <div class="endpoint-desc"><strong>From Make.com</strong> — Log a reply from a lead. Auto-pauses the sequence for this lead and updates their stage.</div>
            <div class="code-block">{
  "lead_id": "uuid-of-lead",
  "subject": "Re: Rodrigues Flooring - AI Automation",
  "body": "Hey, this sounds interesting. Can we talk Thursday?",
  "from_email": "lenny@rodriguesflooring.com"
}</div>
          </div>

          <div class="endpoint-card">
            <div class="endpoint-header">
              <span class="method-badge post">POST</span>
              <span class="endpoint-path">/api/campaigns/:id/bounce</span>
            </div>
            <div class="endpoint-desc"><strong>From Make.com</strong> — Log a bounced email. Marks the lead as bounced and stops the sequence.</div>
            <div class="code-block">{
  "lead_id": "uuid-of-lead",
  "email": "invalid@example.com",
  "reason": "Mailbox not found"
}</div>
          </div>

          <div class="endpoint-card">
            <div class="endpoint-header">
              <span class="method-badge get">GET</span>
              <span class="endpoint-path">/api/campaigns/:id/analytics</span>
            </div>
            <div class="endpoint-desc">Get campaign analytics: sent count, reply rate, bounce rate, step performance, daily sends.</div>
          </div>
        </div>

        <!-- CONVERSATIONS TAB -->
        <div class="tab-content" id="tab-conversations">
          <div class="endpoint-card">
            <div class="endpoint-header">
              <span class="method-badge get">GET</span>
              <span class="endpoint-path">/api/leads/:id/conversations</span>
            </div>
            <div class="endpoint-desc">Get the full conversation history for a lead — all outreach emails sent and replies received, ordered chronologically. <strong>Use this endpoint to give your AI agent full context.</strong></div>
            <div class="code-block">// Response:
{
  "lead_id": "uuid",
  "contact_name": "Lenny Rodrigues",
  "company_name": "Rodrigues Flooring",
  "conversations": [
    {
      "direction": "outbound",
      "subject": "Rodrigues Flooring - AI Automation",
      "body": "Hi Lenny, I noticed...",
      "from": "tulio@flowtier.io",
      "to": "lenny@rodriguesflooring.com",
      "timestamp": "2026-02-26T10:05:00Z",
      "campaign": "Construction Outreach Q1",
      "step": 1
    },
    {
      "direction": "inbound",
      "subject": "Re: Rodrigues Flooring - AI Automation",
      "body": "Hey, this sounds interesting. Can we talk Thursday?",
      "from": "lenny@rodriguesflooring.com",
      "timestamp": "2026-02-26T14:30:00Z"
    }
  ],
  "notes": [...],
  "lead_details": { ... }
}</div>
          </div>
        </div>

        <!-- BLACKLIST TAB -->
        <div class="tab-content" id="tab-blacklist">
          <div class="endpoint-card">
            <div class="endpoint-header">
              <span class="method-badge get">GET</span>
              <span class="endpoint-path">/api/blacklist</span>
            </div>
            <div class="endpoint-desc">Get all blacklisted emails. Blacklisted emails are automatically skipped in all campaigns.</div>
          </div>

          <div class="endpoint-card">
            <div class="endpoint-header">
              <span class="method-badge post">POST</span>
              <span class="endpoint-path">/api/blacklist</span>
            </div>
            <div class="endpoint-desc">Add an email to the global blacklist.</div>
            <div class="code-block">{ "email": "unsubscribe@example.com", "reason": "Requested opt-out" }</div>
          </div>

          <div class="endpoint-card">
            <div class="endpoint-header">
              <span class="method-badge delete">DELETE</span>
              <span class="endpoint-path">/api/blacklist/:email</span>
            </div>
            <div class="endpoint-desc">Remove an email from the blacklist.</div>
          </div>
        </div>
      </div>

      <!-- ═══════════════════════════════════ -->
      <!-- DATA MODEL                          -->
      <!-- ═══════════════════════════════════ -->
      <div class="dev-section" id="data-model">
        <h2>&#128202; Lead Data <span>Model</span></h2>
        <div class="endpoint-card">
          <table class="field-table">
            <thead><tr><th>Field</th><th>Type</th><th>Description</th></tr></thead>
            <tbody>
              <tr><td><code>id</code></td><td>string (UUID)</td><td>Unique lead identifier</td></tr>
              <tr><td><code>company_name</code></td><td>string</td><td>Company name</td></tr>
              <tr><td><code>contact_name</code></td><td>string</td><td>Primary contact name</td></tr>
              <tr><td><code>emails</code></td><td>string[]</td><td>Array of email addresses</td></tr>
              <tr><td><code>phones</code></td><td>string[]</td><td>Array of phone numbers</td></tr>
              <tr><td><code>website</code></td><td>string</td><td>Company website URL</td></tr>
              <tr><td><code>linkedin</code></td><td>string</td><td>LinkedIn profile URL</td></tr>
              <tr><td><code>address</code></td><td>string</td><td>Physical address</td></tr>
              <tr><td><code>industry</code></td><td>string</td><td>Industry category</td></tr>
              <tr><td><code>company_size</code></td><td>string</td><td>Employee count range</td></tr>
              <tr><td><code>revenue_estimate</code></td><td>string</td><td>Estimated revenue</td></tr>
              <tr><td><code>lead_source</code></td><td>string</td><td>How the lead was acquired</td></tr>
              <tr><td><code>tags</code></td><td>string[]</td><td>Flexible labels/tags</td></tr>
              <tr><td><code>stage</code></td><td>string</td><td>Pipeline stage ID</td></tr>
              <tr><td><code>assigned_to</code></td><td>string</td><td>Team member assigned</td></tr>
              <tr><td><code>deal_value</code></td><td>number</td><td>Estimated deal value in dollars</td></tr>
              <tr><td><code>details</code></td><td>string</td><td>Enrichment data / notes</td></tr>
              <tr><td><code>last_contacted</code></td><td>ISO date</td><td>Last contact timestamp</td></tr>
              <tr><td><code>next_followup</code></td><td>ISO date</td><td>Next follow-up date</td></tr>
              <tr><td><code>calendar_event</code></td><td>object</td><td>Google Calendar event details</td></tr>
              <tr><td><code>proposal_url</code></td><td>string</td><td>Link to proposal on proposals.flowtier.io</td></tr>
              <tr><td><code>notes</code></td><td>object[]</td><td>Array of rich text notes with id, title, content (HTML), type, created_at</td></tr>
              <tr><td><code>outreach</code></td><td>object[]</td><td>Array of outreach entries with id, direction, channel, subject, body, created_at</td></tr>
              <tr><td><code>attachments</code></td><td>object[]</td><td>Array of file attachments with id, filename, path, size, created_at</td></tr>
              <tr><td><code>custom_fields</code></td><td>object</td><td>Key-value pairs for custom fields</td></tr>
              <tr><td><code>lead_score</code></td><td>number</td><td>Auto-calculated lead score (0-100)</td></tr>
              <tr><td><code>activity</code></td><td>object[]</td><td>Activity timeline entries</td></tr>
              <tr><td><code>created_at</code></td><td>ISO date</td><td>Creation timestamp</td></tr>
              <tr><td><code>updated_at</code></td><td>ISO date</td><td>Last update timestamp</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- ═══════════════════════════════════ -->
      <!-- MAKE.COM INTEGRATION GUIDE          -->
      <!-- ═══════════════════════════════════ -->
      <div class="dev-section" id="make-integration">
        <h2>&#9881; Make.com <span>Integration Guide</span></h2>

        <div class="endpoint-card">
          <h3 style="font-size:0.875rem;font-weight:700;margin-bottom:12px;">1. Sending Leads from Make.com</h3>
          <div class="endpoint-desc">Use an HTTP module in Make.com to POST leads to the API:</div>
          <div class="code-block">URL: https://leads.flowtier.io/api/leads
Method: POST
Headers:
  Content-Type: application/json
  X-Source: make.com

Body:
{
  "company_name": "{{company_name}}",
  "contact_name": "{{contact_name}}",
  "emails": ["{{email}}"],
  "phones": ["{{phone}}"],
  "industry": "{{industry}}",
  "lead_source": "make.com",
  "details": "{{enrichment_data}}",
  "tags": ["{{tag1}}", "{{tag2}}"]
}</div>
        </div>

        <div class="endpoint-card">
          <h3 style="font-size:0.875rem;font-weight:700;margin-bottom:12px;">2. Receiving Webhooks in Make.com</h3>
          <div class="endpoint-desc">Create a Custom Webhook trigger in Make.com and paste the URL in the Webhook Config above. Events sent:</div>
          <div class="code-block">Events:
  lead_created        — New lead added
  lead_stage_changed  — Lead moved to a different stage
  lead_call_booked    — Calendar event attached to lead

Headers included:
          X-Source: flowtier-lead-system
  X-Event-Type: lead_created | lead_stage_changed | lead_call_booked | lead_outreach_logged</div>
        </div>

        <div class="endpoint-card">
          <h3 style="font-size:0.875rem;font-weight:700;margin-bottom:12px;">3. Updating Lead Stage from Make.com</h3>
          <div class="endpoint-desc">When a lead responds to an email or books a call, update their stage via PATCH:</div>
          <div class="code-block">URL: https://leads.flowtier.io/api/leads/{{lead_id}}
Method: PATCH
Headers:
  Content-Type: application/json

Body:
{ "stage": "qualified" }</div>
        </div>

        <div class="endpoint-card">
          <h3 style="font-size:0.875rem;font-weight:700;margin-bottom:12px;">4. Attaching Google Calendar Events</h3>
          <div class="endpoint-desc">When a call is booked via Calendly or Google Calendar, send the event details:</div>
          <div class="code-block">URL: https://leads.flowtier.io/api/leads/{{lead_id}}/calendar
Method: POST
Headers:
  Content-Type: application/json

Body:
{
  "event_id": "{{google_event_id}}",
  "title": "{{event_title}}",
  "event_date": "{{event_date}}",
  "start_time": "{{start_time}}",
  "end_time": "{{end_time}}",
  "meet_link": "{{hangout_link}}",
  "description": "{{event_description}}",
  "attendees": ["{{attendee_email}}"]
}</div>
          <div class="endpoint-desc" style="margin-top:8px;"><strong>Note:</strong> <code>event_date</code> should be in YYYY-MM-DD format (e.g., "2026-03-01"). You can also add events manually from the lead profile page using the "+ Add Event" button.</div>
        </div>
      </div>

    </main>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ════════════════════════════════════════
    // TEST PAYLOADS
    // ════════════════════════════════════════
    const testPayloads = {
      lead_created: {
        event: 'lead_created',
        timestamp: new Date().toISOString(),
        lead_id: 'test-uuid-' + Date.now(),
        company_name: 'Brightside Dental',
        contact_name: 'Sarah Mitchell',
        emails: ['sarah@brightsidedental.com'],
        phones: ['+1 555-123-4567'],
        industry: 'Dental',
        stage: 'cold',
        lead_source: 'make.com'
      },
      lead_stage_changed: {
        event: 'lead_stage_changed',
        timestamp: new Date().toISOString(),
        lead_id: 'test-uuid-' + Date.now(),
        company_name: 'Brightside Dental',
        contact_name: 'Sarah Mitchell',
        emails: ['sarah@brightsidedental.com'],
        phones: ['+1 555-123-4567'],
        industry: 'Dental',
        old_stage: 'cold',
        new_stage: 'qualified',
        deal_value: 5000
      },
      lead_call_booked: {
        event: 'lead_call_booked',
        timestamp: new Date().toISOString(),
        lead_id: 'test-uuid-' + Date.now(),
        company_name: 'Brightside Dental',
        contact_name: 'Sarah Mitchell',
        emails: ['sarah@brightsidedental.com'],
        calendar_event: {
          event_id: 'gcal_abc123xyz',
          title: 'Discovery Call with Brightside Dental',
          event_date: '2026-03-01',
          start_time: '2026-03-01T14:00:00Z',
          end_time: '2026-03-01T14:30:00Z',
          meet_link: 'https://meet.google.com/abc-defg-hij',
          description: 'Discuss AI chatbot + appointment booking automation',
          attendees: ['sarah@brightsidedental.com', 'tulio@flowtier.io']
        }
      },
      lead_note_added: {
        event: 'lead_note_added',
        timestamp: new Date().toISOString(),
        lead_id: 'test-uuid-' + Date.now(),
        company_name: 'Brightside Dental',
        contact_name: 'Sarah Mitchell',
        note: {
          id: 'note-test-' + Date.now(),
          title: 'Discovery Call - Key Takeaways',
          content: '<h2>Key Takeaways</h2><p>They want AI chatbot for appointment booking. Budget is $5K/month. Decision maker is the office manager.</p>',
          type: 'call_snapshot',
          created_at: new Date().toISOString()
        }
      },
      lead_outreach_logged: {
        event: 'lead_outreach_logged',
        timestamp: new Date().toISOString(),
        lead_id: 'test-uuid-' + Date.now(),
        company_name: 'Brightside Dental',
        contact_name: 'Sarah Mitchell',
        emails: ['sarah@brightsidedental.com'],
        stage: 'contacted',
        outreach: {
          id: 'outreach-test-' + Date.now(),
          direction: 'sent',
          channel: 'email',
          subject: 'AI Automation for Brightside Dental',
          body: 'Hi Sarah, I wanted to reach out about how we can help automate your front office operations with AI...',
          created_at: new Date().toISOString()
        }
      },
      proposal_created: {
        event: 'proposal_created',
        timestamp: new Date().toISOString(),
        proposal_url: 'https://proposals.flowtier.io/brightside-dental',
        slug: 'brightside-dental',
        proposal_id: 'FT26T01',
        lead_id: 'test-uuid-' + Date.now(),
        client: {
          name: 'Sarah Mitchell',
          company: 'Brightside Dental',
          email: 'sarah@brightsidedental.com',
          phone: '+1 555-123-4567'
        },
        project_name: 'AI Front Office Automation',
        pricing: {
          currency: 'usd',
          due_now_cents: 150000,
          total_setup_cents: 250000,
          total_monthly_cents: 49900
        },
        created_date: new Date().toISOString().split('T')[0]
      },
      proposal_signed: {
        event: 'proposal_signed',
        timestamp: new Date().toISOString(),
        proposal_url: 'https://proposals.flowtier.io/brightside-dental',
        slug: 'brightside-dental',
        proposal_id: 'FT26T01',
        lead_id: 'test-uuid-' + Date.now(),
        client: {
          name: 'Sarah Mitchell',
          company: 'Brightside Dental',
          email: 'sarah@brightsidedental.com',
          phone: '+1 555-123-4567'
        },
        signature: {
          name: 'Sarah Mitchell',
          date: new Date().toISOString()
        },
        payment_link: 'https://checkout.stripe.com/pay/cs_test_abc123',
        amount_due: {
          cents: 150000,
          formatted: '$1,500.00',
          currency: 'USD'
        }
      },
      campaign_email_due: {
        event: 'campaign_email_due',
        timestamp: new Date().toISOString(),
        campaign_id: 'camp-test-' + Date.now(),
        campaign_name: 'Construction Outreach Q1',
        step: {
          number: 1,
          subject_template: '{{company_name}} - AI Automation Opportunity',
          body_template: 'Hi {{contact_name}}, I noticed {{company_name}} is growing fast in {{industry}}. We help companies like yours automate their operations with AI...',
          delay_days: 0
        },
        lead: {
          id: 'test-uuid-' + Date.now(),
          contact_name: 'Sarah Mitchell',
          company_name: 'Brightside Dental',
          email: 'sarah@brightsidedental.com',
          industry: 'Dental',
          website: 'brightsidedental.com',
          details: 'Family dental practice, 3 locations, interested in AI chatbot',
          conversation_history: []
        },
        callback_urls: {
          log_send: '/api/campaigns/camp-test/log-send',
          log_reply: '/api/campaigns/camp-test/reply',
          log_bounce: '/api/campaigns/camp-test/bounce'
        },
        _webhook_response_format: {
          _note: 'Make.com should respond to this webhook with the JSON below. The system will use the response to confirm the send and log the actual email content.',
          status: 'sent',
          subject_sent: 'Brightside Dental - AI Automation Opportunity',
          email_sent: 'Hi Sarah, I noticed Brightside Dental is growing fast in Dental. We help companies like yours automate their operations with AI...',
          from_email: 'tulio@flowtier.io'
        }
      },
      campaign_reply_received: {
        event: 'campaign_reply_received',
        timestamp: new Date().toISOString(),
        campaign_id: 'camp-test-' + Date.now(),
        campaign_name: 'Construction Outreach Q1',
        lead: {
          id: 'test-uuid-' + Date.now(),
          contact_name: 'Sarah Mitchell',
          company_name: 'Brightside Dental',
          email: 'sarah@brightsidedental.com'
        },
        reply: {
          subject: 'Re: Brightside Dental - AI Automation Opportunity',
          body: 'Hey, this sounds interesting. Can we schedule a call for Thursday?',
          from_email: 'sarah@brightsidedental.com',
          received_at: new Date().toISOString()
        },
        sequence_paused: true,
        new_stage: 'qualified'
      },
      campaign_email_bounced: {
        event: 'campaign_email_bounced',
        timestamp: new Date().toISOString(),
        campaign_id: 'camp-test-' + Date.now(),
        campaign_name: 'Construction Outreach Q1',
        lead: {
          id: 'test-uuid-' + Date.now(),
          contact_name: 'Sarah Mitchell',
          company_name: 'Brightside Dental',
          email: 'sarah@brightsidedental.com'
        },
        bounce: {
          email: 'sarah@brightsidedental.com',
          reason: 'Mailbox not found',
          bounced_at: new Date().toISOString()
        }
      }
    };

    // ════════════════════════════════════════
    // INIT
    // ════════════════════════════════════════
    document.addEventListener('DOMContentLoaded', async () => {
      // Load webhook URL
      const res = await fetch('/api/webhook-config');
      const data = await res.json();
      document.getElementById('webhookUrl').value = data.url || '';
      updateWebhookStatus(data.url);

      // Render payloads
      Object.keys(testPayloads).forEach(key => {
        const el = document.getElementById('payload_' + key);
        if (el) el.textContent = JSON.stringify(testPayloads[key], null, 2);
      });

      // Save webhook
      document.getElementById('saveWebhookBtn').addEventListener('click', async () => {
        const url = document.getElementById('webhookUrl').value.trim();
        const res = await fetch('/api/webhook-config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url })
        });
        if (res.ok) {
          showToast('Webhook URL saved', 'success');
          updateWebhookStatus(url);
        }
      });

      // Smooth scroll for sidebar links
      document.querySelectorAll('.sidebar-nav a[href^="#"]').forEach(a => {
        a.addEventListener('click', (e) => {
          e.preventDefault();
          const target = document.querySelector(a.getAttribute('href'));
          if (target) target.scrollIntoView({ behavior: 'smooth', block: 'start' });
          document.querySelectorAll('.sidebar-nav .nav-item').forEach(n => n.classList.remove('active'));
          a.classList.add('active');
        });
      });
    });

    function updateWebhookStatus(url) {
      const el = document.getElementById('webhookStatus');
      if (url) {
        el.innerHTML = '<span style="color:var(--color-success);">&#10003;</span> Webhook configured';
      } else {
        el.innerHTML = '<span style="color:var(--color-warning);">&#9888;</span> No webhook URL set. Test buttons will not work.';
      }
    }

    // ════════════════════════════════════════
    // WEBHOOK TESTING
    // ════════════════════════════════════════
    async function testWebhook(eventType) {
      const resultEl = document.getElementById('result_' + eventType);
      resultEl.style.display = 'block';
      resultEl.className = 'test-result';
      resultEl.textContent = 'Sending...';

      // Update timestamps
      testPayloads[eventType].timestamp = new Date().toISOString();

      try {
        const res = await fetch('/api/dev/test-webhook', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            event_type: eventType,
            payload: testPayloads[eventType]
          })
        });
        const data = await res.json();

        if (data.success) {
          resultEl.className = 'test-result success';
          resultEl.textContent = `✓ Sent successfully. Webhook responded with status ${data.webhook_status}.\n\nResponse: ${data.webhook_response || '(empty)'}`;
        } else {
          resultEl.className = 'test-result error';
          resultEl.textContent = `✗ Failed: ${data.error}`;
        }
      } catch (err) {
        resultEl.className = 'test-result error';
        resultEl.textContent = `✗ Error: ${err.message}`;
      }
    }

    function togglePayload(eventType) {
      const el = document.getElementById('payload_' + eventType);
      el.style.display = el.style.display === 'none' ? 'block' : 'none';
    }

    async function loadWebhookHistory() {
      const list = document.getElementById('webhookHistoryList');
      list.innerHTML = '<div style="color:var(--color-text-muted);font-size:0.8125rem;">Loading...</div>';
      try {
        const res = await fetch('/api/webhook-history');
        const data = await res.json();
        const history = data.history || [];
        if (history.length === 0) {
          list.innerHTML = '<div style="color:var(--color-text-muted);font-size:0.8125rem;">No webhook deliveries yet.</div>';
          return;
        }
        list.innerHTML = history.map(h => `
          <div style="padding:8px 12px;border-bottom:1px solid var(--color-border-light);font-size:0.75rem;display:flex;justify-content:space-between;align-items:center;gap:12px;">
            <span style="font-weight:600;">${h.event}</span>
            <span style="color:var(--color-text-muted);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${h.url ? h.url.substring(0, 50) + '...' : 'N/A'}</span>
            <span style="color:${h.success ? 'var(--color-success)' : 'var(--color-danger)'};">${h.success ? '\u2713 ' + h.status_code : '\u2717 ' + (h.error || 'Failed')}</span>
            <span style="color:var(--color-text-muted);">${new Date(h.timestamp).toLocaleString()}</span>
          </div>
        `).join('');
      } catch (e) {
        list.innerHTML = '<div style="color:var(--color-danger);font-size:0.8125rem;">Error: ' + e.message + '</div>';
      }
    }

    // ════════════════════════════════════════
    // TABS
    // ════════════════════════════════════════
    function switchTab(tabId) {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      event.target.classList.add('active');
      document.getElementById('tab-' + tabId).classList.add('active');
    }

    // ════════════════════════════════════════
    // TOAST
    // ════════════════════════════════════════
    function showToast(msg, type) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.className = 'toast ' + type;
      setTimeout(() => t.classList.add('visible'), 10);
      setTimeout(() => t.classList.remove('visible'), 3000);
    }
  </script>
</body>
</html>
